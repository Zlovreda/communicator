<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–æ–º-–ö–æ–º: –ö–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä –¥–ª—è –¥–µ—Ç–µ–π —Å –†–ê–°</title>
  <style>
    /* –í—Å–µ —Å—Ç–∏–ª–∏ –∫—Ä–æ–º–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —Ä–∞—Å–ø–æ—Ä—è–¥–∫–æ–º */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
    }

    body {
      padding: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding-bottom: 120px;
      font-size: var(--base-font-size, 16px);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .tabs-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }

    .tab-btn {
      padding: 10px 20px;
      background: #f8f9fa;
      border: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      color: #555;
      font-weight: bold;
    }

    .tab-btn:hover {
      background: #e9ecef;
    }

    .tab-btn.active {
      background: #3498db;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }

    h1 { font-size: calc(1.5rem * var(--font-scale, 1)); }
    h2 { font-size: calc(1.25rem * var(--font-scale, 1)); }

    .app-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .control-btn {
      padding: 8px 15px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .control-btn:hover {
      background: #2980b9;
    }

    .control-btn.import {
      background: #27ae60;
    }

    .control-btn.export {
      background: #f39c12;
    }

    .control-btn.reset {
      background: #e74c3c;
    }

    .control-btn.remote {
      background: #9b59b6;
    }

    .control-btn.editor {
      background: #17a2b8;
    }

    .phrase-container {
      position: sticky;
      top: 0;
      background: white;
      z-index: 100;
      padding: 10px 0;
      margin-bottom: 15px;
    }

    .phrase-display {
      background: #f0f8ff;
      border: 3px solid #4a90e2;
      border-radius: 12px;
      padding: 20px;
      min-height: 80px;
      font-size: calc(1.25rem * var(--font-scale, 1));
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
    }

    .buttons-container {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 15px 25px;
      font-size: calc(1rem * var(--font-scale, 1));
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: #4a90e2;
      color: white;
    }

    .btn-primary:hover {
      background: #357abd;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #e74c3c;
      color: white;
    }

    .btn-secondary:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-trash {
      background: #95a5a6;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      border-radius: 10px;
      padding: 0;
      font-size: 1.5rem;
    }

    .btn-trash:hover {
      background: #7f8c8d;
      transform: translateY(-2px);
    }

    .navigation-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .back-btn, .home-btn, .actions-btn, .quick-nav-btn, .done-btn {
      padding: 10px 15px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: calc(0.875rem * var(--font-scale, 1));
      transition: all 0.3s;
    }

    .back-btn:hover, .home-btn:hover, .actions-btn:hover, .quick-nav-btn:hover, .done-btn:hover {
      background: #2980b9;
    }

    .home-btn {
      background: #9b59b6;
    }

    .home-btn:hover {
      background: #8e44ad;
    }

    .actions-btn {
      background: #27ae60;
    }

    .actions-btn:hover {
      background: #219653;
    }

    .quick-nav-btn {
      background: #27ae60;
    }

    .quick-nav-btn:hover {
      background: #219653;
    }

    .done-btn {
      background: #2ecc71;
      display: none;
    }

    .done-btn:hover {
      background: #27ae60;
    }

    .done-btn.visible {
      display: block;
    }

    .quick-nav-btn.people {
      background: #3498db;
    }

    .quick-nav-btn.places {
      background: #9b59b6;
    }

    .quick-nav-btn.objects {
      background: #f39c12;
    }

    .quick-nav-btn.time {
      background: #f39c12;
    }

    .quick-nav-btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .quick-nav-btn:disabled:hover {
      background: #95a5a6;
      transform: none;
    }

    .categories-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .category-card {
      background: white;
      border: 2px solid #ddd;
      border-radius: 10px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      box-shadow: 0 3px 5px rgba(0,0,0,0.1);
    }

    .category-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border: 2px solid #ddd;
      border-radius: 10px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      box-shadow: 0 3px 5px rgba(0,0,0,0.1);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .card.selected {
      background: #fff9c4;
      border-color: #ffc107;
      transform: scale(1.05);
    }

    .card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .card-emoji {
      font-size: calc(1.75rem * var(--font-scale, 1));
      margin-bottom: 10px;
    }

    .card-text {
      font-size: calc(0.875rem * var(--font-scale, 1));
      font-weight: bold;
    }

    .selected-items {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      min-height: 60px;
    }

    .selected-item {
      display: flex;
      align-items: center;
      background: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 20px;
      padding: 5px 10px;
      font-size: calc(0.8rem * var(--font-scale, 1));
    }

    .selected-item .remove {
      margin-left: 5px;
      cursor: pointer;
      color: #e74c3c;
      font-weight: bold;
    }

    .file-input {
      display: none;
    }

    .speak-btn {
      background: #9b59b6;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
      font-size: 1.2rem;
      transition: all 0.3s;
    }

    .speak-btn:hover {
      background: #8e44ad;
      transform: scale(1.1);
    }

    .phrase-container {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rules-info {
      margin: 15px 0;
      padding: 10px;
      background: #e1f5fe;
      border-radius: 8px;
      font-size: calc(0.8rem * var(--font-scale, 1));
      color: #0277bd;
    }

    .section-title {
      font-size: calc(1rem * var(--font-scale, 1));
      margin: 20px 0 10px;
      color: #2c3e50;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
    }

    .fixed-bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 15px 20px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .fixed-bottom .buttons-container {
      margin-bottom: 0;
      justify-content: space-around;
    }

    .quick-navigation {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }

    .no-action-message {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
      font-style: italic;
    }

    .selected-item.can-replace {
      border-color: #ff9800;
      background: #fff3e0;
      cursor: pointer;
    }

    .selected-item.can-replace:hover {
      background: #ffecb3;
    }

    .child-info-grid, .emotions-grid, .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .child-card, .emotion-card, .settings-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }

    .child-card:hover, .emotion-card:hover, .settings-card:hover {
      transform: translateY(-5px);
    }

    .child-card h3, .emotion-card h3, .settings-card h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: bold;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: calc(0.875rem * var(--font-scale, 1));
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .save-btn, .edit-btn {
      background: #27ae60;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: calc(0.875rem * var(--font-scale, 1));
      transition: background 0.3s;
      margin-top: 10px;
    }

    .save-btn:hover, .edit-btn:hover {
      background: #219653;
    }

    .edit-btn {
      background: #3498db;
    }

    .view-only {
      background-color: #f5f5f5;
      cursor: not-allowed;
    }

    .pin-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .pin-modal {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
    }

    .pin-input {
      font-size: 24px;
      text-align: center;
      letter-spacing: 8px;
      padding: 10px;
      width: 100%;
      margin: 20px 0;
    }

    .pin-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .pin-btn {
      padding: 15px;
      font-size: 1.2rem;
      border: 2px solid #3498db;
      background: white;
      border-radius: 5px;
      cursor: pointer;
    }

    .pin-btn:hover {
      background: #f0f8ff;
    }

    .warning-message {
      padding: 15px;
      background: #fff3e0;
      border: 1px solid #ff9800;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #ef6c00;
    }

    .emergency-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .emergency-card {
      background: white;
      border: 2px solid #e74c3c;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }

    .emergency-card:hover {
      background: #ffebee;
      transform: scale(1.05);
    }

    .emergency-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .emergency-title {
      font-size: 1.1rem;
      font-weight: bold;
      color: #c0392b;
    }

    .emoji-picker {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-top: 10px;
    }

    .emoji-option {
      font-size: 1.5rem;
      cursor: pointer;
      text-align: center;
      padding: 5px;
      border-radius: 5px;
      transition: background 0.3s;
    }

    .emoji-option:hover {
      background: #e9ecef;
    }

    .learning-category {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .color-card {
      min-height: 100px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .btn-learning {
      background: #9b59b6;
      color: white;
    }

    .btn-learning:hover {
      background: #8e44ad;
    }

    .btn-dialog {
      background: #3498db;
      color: white;
    }

    .btn-dialog:hover {
      background: #2980b9;
    }

    .btn-dialog-negative {
      background: #e74c3c;
      color: white;
    }

    .btn-dialog-negative:hover {
      background: #c0392b;
    }

    .tab-title {
      font-size: 1.2rem;
      margin: 20px 0 15px;
      color: #2c3e50;
      text-align: center;
      padding: 10px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-radius: 8px;
    }

    .settings-info {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .settings-info-item {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .settings-info-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .settings-info-label {
      font-weight: bold;
      color: #2c3e50;
    }

    .settings-info-value {
      color: #666;
    }

    .settings-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .slider-value {
      min-width: 40px;
      text-align: center;
      font-weight: bold;
    }

    input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: #ddd;
      outline: none;
    }

    .font-size-demo {
      padding: 15px;
      background: #f0f8ff;
      border-radius: 8px;
      border: 1px solid #4a90e2;
      margin-top: 10px;
      text-align: center;
    }

    .history-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: #f8f9fa;
    }

    .history-item {
      padding: 10px;
      margin-bottom: 8px;
      background: white;
      border-radius: 5px;
      border-left: 4px solid #3498db;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-item:hover {
      background: #f0f8ff;
    }

    .history-time {
      font-size: 0.8rem;
      color: #7f8c8d;
    }

    .history-text {
      flex: 1;
      margin-right: 10px;
    }

    .history-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    @media (max-width: 768px) {
      .categories-container, .cards-container {
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      }

      .btn {
        padding: 12px 20px;
        font-size: calc(0.875rem * var(--font-scale, 1));
      }

      .btn-trash {
        width: 50px;
        height: 50px;
      }

      .phrase-display {
        font-size: calc(1rem * var(--font-scale, 1));
        padding: 15px;
      }

      .navigation-controls {
        flex-direction: column;
      }

      .quick-navigation {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
      }

      .quick-nav-btn {
        padding: 8px 12px;
        font-size: calc(0.8rem * var(--font-scale, 1));
      }

      .tabs-container {
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 5px;
      }

      .tab-btn {
        padding: 8px 12px;
        font-size: 0.8rem;
        white-space: nowrap;
      }

      .emergency-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }

      .child-info-grid, .emotions-grid, .settings-grid {
        grid-template-columns: 1fr;
      }
    }

    .footer-link {
      color: #3498db;
      text-decoration: none;
      margin-right: 10px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .footer-link:hover {
      text-decoration: underline;
      color: #2980b9;
    }
	
	/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
.pin-modal input[type="radio"],
.pin-modal input[type="checkbox"] {
  margin-right: 8px;
}

.pin-modal label {
  display: flex;
  align-items: flex-start;
  margin-bottom: 8px;
  cursor: pointer;
  line-height: 1.4;
}

.pin-modal strong {
  color: #2c3e50;
}

#sectionsSelection label {
  margin-bottom: 5px;
}

#summaryInfo {
  background: #e8f5e9 !important;
  border: 1px solid #27ae60;
}

#sectionCounts {
  font-size: 0.9rem;
  color: #2e7d32;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
.pin-modal {
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
  </style>
</head>
<body>
  <div class="container">
    <h1>–ö–æ–º-–ö–æ–º: –ö–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä –¥–ª—è –¥–µ—Ç–µ–π —Å –†–ê–° (–¢–µ—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)</h1>

    <div class="tabs-container">
      <button class="tab-btn active" data-tab="main">–ì–ª–∞–≤–Ω–∞—è</button>
      <button class="tab-btn" data-tab="learning">–û–±—É—á–µ–Ω–∏–µ</button>
      <button class="tab-btn" data-tab="dialog">–î–∏–∞–ª–æ–≥</button>
      <button class="tab-btn" data-tab="emotions">–≠–º–æ—Ü–∏–∏</button>
      <button class="tab-btn" data-tab="emergency">–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏</button>
      <button class="tab-btn" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button class="tab-btn" data-tab="child">–î–∞–Ω–Ω—ã–µ –æ —Ä–µ–±–µ–Ω–∫–µ</button>
      <button class="tab-btn" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div id="main" class="tab-content active">
      <div class="phrase-container">
        <div class="phrase-display" id="phraseDisplay"></div>
        <button class="speak-btn" id="speakBtn">üîä</button>
      </div>

      <div class="selected-items" id="selectedItems"></div>
      <div class="rules-info" id="rulesInfo"></div>

      <div class="navigation-controls">
        <button class="back-btn" id="backBtn" style="display: none;">–ù–∞–∑–∞–¥</button>
        <button class="home-btn" id="homeBtn">–ì–ª–∞–≤–Ω–∞—è</button>
        <button class="actions-btn" id="actionsBtn">–î–µ–π—Å—Ç–≤–∏—è</button>
        <button class="done-btn" id="doneBtn">–ì–æ—Ç–æ–≤–æ</button>
        <div class="quick-navigation" id="quickNavigation" style="display: none;">
          <button class="quick-nav-btn objects" id="quickObjectsBtn">–û–±—ä–µ–∫—Ç—ã</button>
          <button class="quick-nav-btn people" id="quickPeopleBtn">–õ—é–¥–∏</button>
          <button class="quick-nav-btn places" id="quickPlacesBtn">–ú–µ—Å—Ç–∞</button>
          <button class="quick-nav-btn time" id="quickTimeBtn">–í—Ä–µ–º—è</button>
        </div>
      </div>

      <div id="categoriesView">
        <div class="section-title">–û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
        <div class="categories-container" id="categoriesContainer"></div>
      </div>

      <div id="cardsView" style="display: none;">
        <div class="cards-container" id="cardsContainer"></div>
      </div>
    </div>

    <div id="child" class="tab-content">
      <h2>–î–∞–Ω–Ω—ã–µ –æ —Ä–µ–±–µ–Ω–∫–µ</h2>
      <button class="edit-btn" id="editChildBtn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <div class="child-info-grid" id="childInfoGrid"></div>
    </div>

    <div id="emotions" class="tab-content">
      <h2>–≠–º–æ—Ü–∏–∏</h2>
      <div class="navigation-controls">
        <button class="back-btn" id="backBtnEmotions" style="display: none;">–ù–∞–∑–∞–¥</button>
        <button class="home-btn" id="homeBtnEmotions">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —ç–º–æ—Ü–∏–π</button>
      </div>
      <div id="emotionsCategoriesView">
        <div class="section-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —ç–º–æ—Ü–∏–∏</div>
        <div class="categories-container" id="emotionsCategoriesContainer"></div>
      </div>
      <div id="emotionsCardsView" style="display: none;">
        <div class="cards-container" id="emotionsCardsContainer"></div>
      </div>
    </div>

    <div id="learning" class="tab-content">
      <h2>–û–±—É—á–µ–Ω–∏–µ</h2>
      <div class="navigation-controls">
        <button class="back-btn" id="backBtnLearning" style="display: none;">–ù–∞–∑–∞–¥</button>
        <button class="home-btn" id="homeBtnLearning">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—É—á–µ–Ω–∏—è</button>
      </div>
      <div id="learningCategoriesView">
        <div class="section-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—É—á–µ–Ω–∏—è</div>
        <div class="categories-container" id="learningCategoriesContainer"></div>
      </div>
      <div id="learningCardsView" style="display: none;">
        <div class="cards-container" id="learningCardsContainer"></div>
      </div>
    </div>

    <div id="dialog" class="tab-content">
      <h2>–î–∏–∞–ª–æ–≥</h2>
      <div class="navigation-controls">
        <button class="back-btn" id="backBtnDialog" style="display: none;">–ù–∞–∑–∞–¥</button>
        <button class="home-btn" id="homeBtnDialog">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞</button>
      </div>
      <div id="dialogCategoriesView">
        <div class="section-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞</div>
        <div class="categories-container" id="dialogCategoriesContainer"></div>
      </div>
      <div id="dialogCardsView" style="display: none;">
        <div class="cards-container" id="dialogCardsContainer"></div>
      </div>
    </div>

    <div id="emergency" class="tab-content">
      <h2>–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏</h2>
      <div class="warning-message">
        ‚ö†Ô∏è <strong>–í–∞–∂–Ω–æ:</strong> –≠—Ç–∏ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤. –ù–∞–∂–º–∏—Ç–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ —Å—Ä–æ—á–Ω–∞—è –ø–æ–º–æ—â—å.
      </div>
      <div class="emergency-grid">
        <div class="emergency-card" id="emergencyHelp">
          <div class="emergency-icon">üÜò</div>
          <div class="emergency-title">–ü–æ–º–æ—â—å!</div>
          <div>–°—Ä–æ—á–Ω–æ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å</div>
        </div>
        <div class="emergency-card" id="emergencyPain">
          <div class="emergency-icon">ü§ï</div>
          <div class="emergency-title">–ë–æ–ª—å–Ω–æ!</div>
          <div>–°–∏–ª—å–Ω–∞—è –±–æ–ª—å</div>
        </div>
        <div class="emergency-card" id="emergencyScared">
          <div class="emergency-icon">üò®</div>
          <div class="emergency-title">–°—Ç—Ä–∞—à–Ω–æ!</div>
          <div>–ú–Ω–µ —Å—Ç—Ä–∞—à–Ω–æ</div>
        </div>
        <div class="emergency-card" id="emergencySick">
          <div class="emergency-icon">ü§¢</div>
          <div class="emergency-title">–¢–æ—à–Ω–∏—Ç!</div>
          <div>–ü–ª–æ—Ö–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ</div>
        </div>
        <div class="emergency-card" id="emergencyLost">
          <div class="emergency-icon">üó∫Ô∏è</div>
          <div class="emergency-title">–Ø –∑–∞–±–ª—É–¥–∏–ª—Å—è</div>
          <div>–°–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å</div>
        </div>
        <div class="emergency-card" id="emergencyCall">
          <div class="emergency-icon">üìû</div>
          <div class="emergency-title">–ü–æ–∑–≤–æ–Ω–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è–º</div>
          <div>–ù–∞–∂–º–∏—Ç–µ –≤ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–º —Å–ª—É—á–∞–µ</div>
        </div>
        <div class="emergency-card" id="emergencyStop">
          <div class="emergency-icon">üõë</div>
          <div class="emergency-title">–°—Ç–æ–ø!</div>
          <div>–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è</div>
        </div>
      </div>
    </div>

    <div id="history" class="tab-content">
      <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</h2>
      <div class="history-controls">
        <button class="control-btn" id="clearHistoryBtn">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        <button class="control-btn export" id="exportHistoryBtn">–≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏</button>
      </div>
      <div class="history-container" id="historyContainer"></div>
    </div>

    <div id="settings" class="tab-content">
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <div class="settings-grid">
        <div class="settings-card">
          <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
          <div class="settings-controls">
            <button class="control-btn import" id="importBtn">–ò–º–ø–æ—Ä—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</button>
            <button class="control-btn export" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</button>
            <button class="control-btn remote" id="remoteLoadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞</button>
            <button class="control-btn editor" id="editorBtn">–†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫</button>
            <button class="control-btn reset" id="resetBtn">–°–±—Ä–æ—Å –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º</button>
            <input type="file" id="fileInput" class="file-input" accept=".json">
          </div>
        </div>

        <div class="settings-card">
          <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h3>
          <div class="form-group">
            <label>–¢–µ–∫—É—â–∏–π PIN-–∫–æ–¥</label>
            <input type="password" id="currentPin" maxlength="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π PIN">
          </div>
          <div class="form-group">
            <label>–ù–æ–≤—ã–π PIN-–∫–æ–¥ (4 —Ü–∏—Ñ—Ä—ã)</label>
            <input type="password" id="newPin" maxlength="4" placeholder="–ù–æ–≤—ã–π PIN">
          </div>
          <div class="form-group">
            <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π PIN-–∫–æ–¥</label>
            <input type="password" id="confirmPin" maxlength="4" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ PIN">
          </div>
          <button class="save-btn" id="changePinBtn">–°–º–µ–Ω–∏—Ç—å PIN</button>
        </div>

        <div class="settings-card">
          <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—á–∏</h3>
          <div class="form-group">
            <label>–°–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è: <span id="speedValue">1.0</span></label>
            <div class="slider-container">
              <span>–ú–µ–¥–ª–µ–Ω–Ω–µ–µ</span>
              <input type="range" id="speedSlider" min="0.5" max="2" step="0.1" value="1.0">
              <span>–ë—ã—Å—Ç—Ä–µ–µ</span>
            </div>
          </div>
          <div class="form-group">
            <label>–ì–æ–ª–æ—Å –¥–ª—è —á—Ç–µ–Ω–∏—è</label>
            <select id="voiceSelect">
              <option value="">–°–∏—Å—Ç–µ–º–Ω—ã–π –≥–æ–ª–æ—Å</option>
            </select>
          </div>
        </div>

        <div class="settings-card">
          <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
          <div class="form-group">
            <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞: <span id="fontSizeValue">100%</span></label>
            <div class="slider-container">
              <span>–ú–µ–Ω—å—à–µ</span>
              <input type="range" id="fontSizeSlider" min="70" max="150" step="5" value="100">
              <span>–ë–æ–ª—å—à–µ</span>
            </div>
          </div>
          <div class="font-size-demo" id="fontSizeDemo">–ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞: –Ø —Ö–æ—á—É –∏–≥—Ä–∞—Ç—å</div>
        </div>

		<div class="settings-card">
  <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ</h3>
  <div class="settings-info" id="systemInfo"></div>
</div>

<div class="settings-card">
  <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
  <div class="settings-info">
    <div class="settings-controls" style="display: flex; flex-direction: column; gap: 10px;">
      <a href="https://zlovreda.github.io/Kom-Kom-Communicator/index-manual.html" 
         target="_blank" 
         class="control-btn" 
         style="background: #3498db; text-decoration: none; text-align: center;">
        üìñ –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
      </a>
      <button class="control-btn editor" id="editorBtnFromInstructions" style="background: #17a2b8;">
        üìù –†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫
      </button>
      <a href="https://zlovreda.github.io/Kom-Kom-Communicator/schedule.html" 
         target="_blank" 
         class="control-btn" 
         style="background: #9b59b6; text-decoration: none; text-align: center;">
        üìÖ –†–∞—Å–ø–æ—Ä—è–¥–æ–∫ –¥–Ω—è
      </a>
      <a href="https://t.me/kom_kom_chat" 
         target="_blank" 
         class="control-btn" 
         style="background: #0088cc; text-decoration: none; text-align: center;">
        üí¨ –¢–µ–ª–µ–≥—Ä–∞–º-—á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏
      </a>
    </div>
  </div>
  <p style="margin-top: 15px; font-size: 0.9rem; color: #666;">
    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä–æ–º.
  </p>
</div>

<div class="settings-card">
  <h3>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
  <div class="settings-info">
    <div class="settings-info-item">
      <span class="settings-info-label">–õ–∏—Ü–µ–Ω–∑–∏—è:</span>
      <span class="settings-info-value">
        <a href="https://github.com/Zlovreda/Kom-Kom-Communicator/blob/main/LICENSE" target="_blank" class="footer-link">üìú Apache License 2.0</a>
      </span>
    </div>
    <div class="settings-info-item">
      <span class="settings-info-label">–ê–≤—Ç–æ—Ä:</span>
      <span class="settings-info-value">
        <a href="https://github.com/Zlovreda" target="_blank" class="footer-link">üë§ Zlovreda</a>
      </span>
    </div>
    <div class="settings-info-item">
      <span class="settings-info-label">Copyright:</span>
      <span class="settings-info-value">¬© 2025 Pavel Nikolaevich Kopchenov</span>
    </div>
    <div class="settings-info-item">
      <span class="settings-info-label">–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:</span>
      <span class="settings-info-value">
        <a href="https://github.com/Zlovreda/Kom-Kom-Communicator" target="_blank" class="footer-link">GitHub</a>
      </span>
    </div>
  </div>
  <p style="margin-top: 15px; font-size: 0.9rem; color: #666;">
    –ö–æ–º-–ö–æ–º - –æ—Ç–∫—Ä—ã—Ç—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –ø–æ–º–æ—â–∏ –¥–µ—Ç—è–º —Å —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –∞—É—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–ø–µ–∫—Ç—Ä–∞.
  </p>
</div>

<div class="settings-card">
  <h3>–û–± –∞–≤—Ç–æ—Ä–µ</h3>
  <div class="settings-info">
    <p style="margin-top: 15px; font-size: 0.9rem; color: #666;">
      –ö–∞–∫ –≥–æ–≤–æ—Ä–∏—Ç —Å–∞–º –ü–∞–≤–µ–ª, —Å–Ω–∞—á–∞–ª–∞ –æ–Ω ‚Äì –ª—é–±—è—â–∏–π –º—É–∂ –∏ –æ—Ç–µ—Ü –¥–≤–æ–∏—Ö –¥–µ—Ç–µ–π –∞—É—Ç–∏—Å—Ç–æ–≤, –∞ —É–∂–µ –ø–æ—Ç–æ–º –ø–∏—Å–∞—Ç–µ–ª—å, –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ, –∏–ª–ª—é—Å—Ç—Ä–∞—Ç–æ—Ä –∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ. –û–Ω —Å–æ–∑–¥–∞–ª –±–æ–ª–µ–µ —Å–æ—Ç–Ω–∏ –∫–∞—Ä—Ç, –¥–ª—è –º–Ω–æ–≥–∏—Ö –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤, —Ñ–æ—Ä–∑–∞—Ü–µ–≤ –∫–Ω–∏–≥ —Å–µ—Ä–∏–∏ ¬´–ú–µ—Ç–∞–≤—Å–µ–ª–µ–Ω–Ω—ã–µ —Ñ—ç–Ω—Ç–µ–∑–∏¬ª –∏ —Ç.–¥. –ü–∞–≤–µ–ª ‚Äì –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä—Å–æ–≤, —á–µ–ª–æ–≤–µ–∫, —Ç–≤–æ—Ä—è—â–∏–π —Å–≤–æ–∏ –º–∏—Ä—ã –∏ —Ä–∏—Å—É—é—â–∏–π —á—É–∂–∏–µ. 
    </p>
    <div class="settings-info-item">
      <span class="settings-info-label">–î–µ—Ç—Å–∫–∏–µ –∫–Ω–∏–≥–∏:</span>
      <span class="settings-info-value">
        <a href="https://www.wildberries.ru/catalog/244040534/detail.aspx" target="_blank" class="footer-link">üìú –í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑</a>
        <a href="https://www.ozon.ru/product/hozyain-letayushchego-ostrova-kopchenov-p-n-metavselennye-fentezi-detskaya-literatura-fentezi-knigi-1636299589/" target="_blank" class="footer-link">üìú –û–∑–æ–Ω</a>
        <a href="https://www.litres.ru/book/pavel-kopchenov/hozyain-letauschego-ostrova-70914040/" target="_blank" class="footer-link">üìú –õ–∏—Ç—Ä–µ—Å</a>
      </span>
    </div>
    <div class="settings-info-item">
      <span class="settings-info-label">–í–∑—Ä–æ—Å–ª—ã–µ –∫–Ω–∏–≥–∏:</span>
      <span class="settings-info-value">
        <a href="https://author.today/u/zlovreda/works" target="_blank" class="footer-link">üìú Author.today</a>
      </span>
    </div>
  </div>
</div>

  <div class="fixed-bottom" id="mainButtonsContainer">
    <div class="buttons-container">
      <button class="btn btn-primary" id="btnI">üë§ –Ø</button>
      <button class="btn btn-primary" id="btnWant">üëç –•–æ—á—É</button>
      <button class="btn btn-secondary" id="btnDontWant">üëé –ù–µ —Ö–æ—á—É</button>
      <button class="btn btn-trash" id="clearBtn">üóëÔ∏è</button>
    </div>
  </div>

  <div class="fixed-bottom" id="learningButtonsContainer" style="display: none;">
    <div class="buttons-container">
      <button class="btn btn-learning" id="btnDontUnderstand">–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é</button>
      <button class="btn btn-learning" id="btnFoundError">–ù–∞—à–µ–ª –æ—à–∏–±–∫—É</button>
      <button class="btn btn-learning" id="btnExplainMe">–û–±—ä—è—Å–Ω–∏—Ç–µ –º–Ω–µ</button>
      <button class="btn btn-trash" id="clearLearningBtn">üóëÔ∏è</button>
    </div>
  </div>

  <div class="fixed-bottom" id="dialogButtonsContainer" style="display: none;">
    <div class="buttons-container">
      <button class="btn btn-dialog" id="btnYes">–î–∞</button>
      <button class="btn btn-dialog-negative" id="btnNo">–ù–µ—Ç</button>
      <button class="btn btn-dialog" id="btnDontKnow">–ù–µ –∑–Ω–∞—é</button>
      <button class="btn btn-trash" id="clearDialogBtn">üóëÔ∏è</button>
    </div>
  </div>

  <div id="pinOverlay" class="pin-overlay" style="display: none;">
    <div class="pin-modal">
      <h3>–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥</h3>
      <input type="password" id="pinInput" class="pin-input" maxlength="4" readonly>
      <div class="pin-buttons">
        <button class="pin-btn" data-pin="1">1</button>
        <button class="pin-btn" data-pin="2">2</button>
        <button class="pin-btn" data-pin="3">3</button>
        <button class="pin-btn" data-pin="4">4</button>
        <button class="pin-btn" data-pin="5">5</button>
        <button class="pin-btn" data-pin="6">6</button>
        <button class="pin-btn" data-pin="7">7</button>
        <button class="pin-btn" data-pin="8">8</button>
        <button class="pin-btn" data-pin="9">9</button>
        <button class="pin-btn" data-pin="0">0</button>
        <button class="pin-btn" data-pin="clear">–°—Ç–µ—Ä–µ—Ç—å</button>
        <button class="pin-btn" data-pin="enter">–í–≤–æ–¥</button>
      </div>
      <div style="text-align: center; margin-top: 20px;">
        <button id="pinCancel" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

<div id="remoteLoadModal" class="pin-overlay" style="display: none;">
  <div class="pin-modal" style="max-width: 500px;">
    <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞</h3>
    
    <div class="form-group">
      <label><strong>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∑–∞–≥—Ä—É–∑–∫–∏:</strong></label>
      <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 10px;">
          <input type="radio" name="loadStrategy" value="replace" checked>
          <strong>–ó–ê–ú–ï–ù–ò–¢–¨ –í–°–ï</strong> - –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ (—Ç–µ–∫—É—â–∏–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã)
        </label>
        <label style="display: block; margin-bottom: 10px;">
          <input type="radio" name="loadStrategy" value="merge">
          <strong>–û–ë–™–ï–î–ò–ù–ò–¢–¨</strong> - –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
        </label>
        <label style="display: block; margin-bottom: 10px;">
          <input type="radio" name="loadStrategy" value="sections">
          <strong>–í–´–ë–û–†–û–ß–ù–ê–Ø</strong> - –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã
        </label>
      </div>
    </div>

    <div id="sectionsSelection" style="display: none; margin-top: 15px;">
      <label><strong>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:</strong></label>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
        <label style="display: flex; align-items: center;">
          <input type="checkbox" name="section" value="–ì–ª–∞–≤–Ω–∞—è" checked>
          üì± –ì–ª–∞–≤–Ω–∞—è
        </label>
        <label style="display: flex; align-items: center;">
          <input type="checkbox" name="section" value="–û–±—É—á–µ–Ω–∏–µ">
          üéì –û–±—É—á–µ–Ω–∏–µ
        </label>
        <label style="display: flex; align-items: center;">
          <input type="checkbox" name="section" value="–î–∏–∞–ª–æ–≥">
          üí¨ –î–∏–∞–ª–æ–≥
        </label>
        <label style="display: flex; align-items: center;">
          <input type="checkbox" name="section" value="–≠–º–æ—Ü–∏–∏">
          üòä –≠–º–æ—Ü–∏–∏
        </label>
      </div>
      
      <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 5px;">
        <label style="display: block; margin-bottom: 5px;">
          <input type="checkbox" id="skipCategories">
          –ù–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∏)
        </label>
        <label style="display: block;">
          <input type="checkbox" id="preserveExisting">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –Ω–µ–≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö
        </label>
      </div>
    </div>

    <div id="summaryInfo" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
      <div style="font-weight: bold; margin-bottom: 5px;">–ë—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ:</div>
      <div id="sectionCounts">0 –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑ 0 —Ä–∞–∑–¥–µ–ª–æ–≤</div>
    </div>

    <div style="text-align: center; margin-top: 20px;">
      <button id="confirmRemoteLoad" class="control-btn" style="background: #27ae60;">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <button id="cancelRemoteLoad" class="control-btn" style="background: #e74c3c; margin-left: 10px;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

  <script>
    const REMOTE_CARDS_URL = 'https://raw.githubusercontent.com/Zlovreda/communicator/refs/heads/main/cards.json';
    const EDITOR_URL = 'https://zlovreda.github.io/Kom-Kom-Communicator/editor.html';
    const DEFAULT_PIN = "0000";
    
    let currentPin = localStorage.getItem('communicator_pin') || DEFAULT_PIN;
    let pinAction = null;
    let isEditingEnabled = false;
    let speechRate = parseFloat(localStorage.getItem('speech_rate') || '1.0');
    let fontSizeScale = parseFloat(localStorage.getItem('font_size_scale') || '1.0');
    let voices = [];
    let selectedVoice = null;
    let history = JSON.parse(localStorage.getItem('communicator_history') || '[]');
    
class AdvancedGrammarSystem {
  constructor() {
    this.rules = {
      // –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–∞—Ä—Ç–æ—á–µ–∫
      'person': { 
        storeIn: 'people',
        preposition: '—Å', 
        case: 'instrumental', 
        joinPreposition: true 
      },
      'pet': { 
        storeIn: 'pets',
        preposition: null, 
        case: 'accusative', 
        directObject: true 
      },
      'place': { 
        storeIn: 'places',
        preposition: null, 
        case: 'locative', 
        specialForm: true 
      },
      'object': { 
        storeIn: 'objects',
        preposition: '—Å', 
        case: 'instrumental', 
        joinPreposition: true 
      },
      'clothing': { 
        storeIn: 'objects',
        preposition: '–≤', 
        case: 'accusative', 
        joinPreposition: false,
        directObject: true 
      },
      'time': { 
        storeIn: 'time',
        preposition: null, 
        case: 'adverbial' 
      },
      'food': { 
        storeIn: 'objects',
        preposition: null, 
        case: 'accusative', 
        directObject: true 
      },
      'drink': { 
        storeIn: 'objects',
        preposition: null, 
        case: 'accusative', 
        directObject: true 
      },
      'hygiene-tool': { 
        storeIn: 'objects',
        preposition: '—Å', 
        case: 'instrumental', 
        joinPreposition: true 
      },
      'transport': { 
        storeIn: 'objects',
        preposition: '–Ω–∞', 
        case: 'locative', 
        joinPreposition: false 
      },
      'toilet': { 
        storeIn: 'objects',
        preposition: null, 
        case: 'adverbial', 
        standalone: true 
      },
      'pain': {
        storeIn: 'objects',
        preposition: null,
        case: 'nominative',
        directObject: false,
        forPain: true
      },
      'learning': {
        storeIn: null,
        standalone: true
      },
      'dialog': {
        storeIn: null,
        standalone: true
      },
      'emotion': {
        storeIn: null,
        standalone: true
      }
    };
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    this.actionRules = {
      // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
      'ACT-EAT': { 
        type: 'consumption', 
        directObject: true,
        allowedStores: ['objects', 'people', 'places', 'time'],
        requiresDesire: true,
        requiresSubject: true
      },
      'ACT-DRINK': { 
        type: 'consumption', 
        directObject: true,
        allowedStores: ['objects', 'people', 'places', 'time'],
        requiresDesire: true,
        requiresSubject: true
      },
      'ACT-RIDE': { 
        type: 'movement', 
        transportPreposition: '–Ω–∞',
        allowedStores: ['objects', 'people', 'places', 'time'],
        requiresDesire: true,
        requiresSubject: true
      },
      'ACT-WEAR': { 
        type: 'dressing', 
        clothingPreposition: '–≤',
        allowedStores: ['objects', 'places', 'time'],
        requiresDesire: true,
        requiresSubject: true
      },
      'ACT-UNDRESS': { 
        type: 'dressing', 
        allowedStores: ['objects', 'places', 'time'],
        requiresDesire: true,
        requiresSubject: true
      },
      'ACT-PLAY': { 
        type: 'activity', 
        allowedStores: ['objects', 'people', 'places', 'time'],
        requiresDesire: true,
        requiresSubject: true
      },
      'ACT-PET': { 
        type: 'interaction', 
        directObject: true,
        allowedStores: ['pets', 'places', 'time'],
        requiresDesire: true,
        requiresSubject: true
      },
      'ACT-WASH-HANDS': { 
        type: 'hygiene', 
        allowedStores: ['objects', 'places', 'time'],
        requiresDesire: true,
        requiresSubject: true
      },
      'ACT-BRUSH-TEETH': { 
        type: 'hygiene', 
        allowedStores: ['objects', 'places', 'time'],
        requiresDesire: true,
        requiresSubject: true
      },
'ACT-PEE': { 
  type: 'toilet', 
  allowedStores: ['places', 'time'],
  requiresDesire: true,
  requiresSubject: true
},
'ACT-POO': { 
  type: 'toilet', 
  allowedStores: ['places', 'time'],
  requiresDesire: true,
  requiresSubject: true
},
      'ACT-SHOWER': { 
        type: 'hygiene', 
        standalone: true,
        allowedStores: ['places', 'time']
      },
      'ACT-HELP': { 
        type: 'emergency', 
        standalone: true
      },
      
      // –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –±–æ–ª–∏
      'ACT-HURT': {
        type: 'medical',
        requiresSubject: true,
        requiresPainObject: true,
        maxObjects: 1,
        allowedStores: ['objects'],
        directObject: false,
        painConstruction: true
      },
      'ACT-HURTS-A-LOT': {
        type: 'medical',
        requiresSubject: true,
        requiresPainObject: true,
        maxObjects: 1,
        allowedStores: ['objects'],
        directObject: false,
        painConstruction: true
      },
      'ACT-HELP-PAIN': {
        type: 'medical',
        standalone: true,
        requiresSubject: false
      }
    };
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—ã –¥–ª—è –º–µ—Å—Ç
    this.specialPlaceForms = {
      '–¥–æ–º': '–¥–æ–º–∞',
      '–ø–ª–æ—â–∞–¥–∫–∞': '–Ω–∞ –ø–ª–æ—â–∞–¥–∫–µ',
      '–ø–∞—Ä–∫': '–≤ –ø–∞—Ä–∫–µ',
      '—à–∫–æ–ª–∞': '–≤ —à–∫–æ–ª–µ',
      '–º–∞–≥–∞–∑–∏–Ω': '–≤ –º–∞–≥–∞–∑–∏–Ω–µ',
      '–∫–∞—Ñ–µ': '–≤ –∫–∞—Ñ–µ',
      '—Ç—É–∞–ª–µ—Ç': '–≤ —Ç—É–∞–ª–µ—Ç–µ',
      '–≤–∞–Ω–Ω–∞—è': '–≤ –≤–∞–Ω–Ω–æ–π'
    };
    
    // –§–æ—Ä–º—ã –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ñ—Ä–∞–∑ —Å –±–æ–ª—å—é
    this.painPatterns = {
      '–≥–æ–ª–æ–≤–∞': '–≥–æ–ª–æ–≤–∞',
      '–∑—É–±': '–∑—É–±',
      '–∑—É–±—ã': '–∑—É–±—ã',
      '–∂–∏–≤–æ—Ç': '–∂–∏–≤–æ—Ç',
      '—É—Ö–æ': '—É—Ö–æ',
      '—É—à–∏': '—É—à–∏',
      '–≥–æ—Ä–ª–æ': '–≥–æ—Ä–ª–æ',
      '–Ω–æ–≥–∞': '–Ω–æ–≥–∞',
      '–Ω–æ–≥–∏': '–Ω–æ–≥–∏',
      '—Ä—É–∫–∞': '—Ä—É–∫–∞',
      '—Ä—É–∫–∏': '—Ä—É–∫–∏',
      '—Å–ø–∏–Ω–∞': '—Å–ø–∏–Ω–∞',
      '–≥–ª–∞–∑': '–≥–ª–∞–∑',
      '–≥–ª–∞–∑–∞': '–≥–ª–∞–∑–∞',
      '–Ω–æ—Å': '–Ω–æ—Å',
      '–ø–∞–ª–µ—Ü –Ω–æ–≥–∏': '–ø–∞–ª–µ—Ü –Ω–∞ –Ω–æ–≥–µ',
      '–ø–∞–ª—å—Ü—ã –Ω–æ–≥': '–ø–∞–ª—å—Ü—ã –Ω–∞ –Ω–æ–≥–∞—Ö',
      '–ø–∞–ª–µ—Ü —Ä—É–∫–∏': '–ø–∞–ª–µ—Ü –Ω–∞ —Ä—É–∫–µ',
      '–ø–∞–ª—å—Ü—ã —Ä—É–∫': '–ø–∞–ª—å—Ü—ã –Ω–∞ —Ä—É–∫–∞—Ö',
      '–≥—Ä—É–¥—å': '–≥—Ä—É–¥—å',
      '—Å–µ—Ä–¥—Ü–µ': '—Å–µ—Ä–¥—Ü–µ',
      '—à–µ—è': '—à–µ—è',
      '–∫–æ–ª–µ–Ω–æ': '–∫–æ–ª–µ–Ω–æ',
      '–∫–æ–ª–µ–Ω–∏': '–∫–æ–ª–µ–Ω–∏',
      '–ª–æ–∫–æ—Ç—å': '–ª–æ–∫–æ—Ç—å',
      '–ª–æ–∫—Ç–∏': '–ª–æ–∫—Ç–∏',
      '–ø–ª–µ—á–æ': '–ø–ª–µ—á–æ',
      '–ø–ª–µ—á–∏': '–ø–ª–µ—á–∏',
      '–ª–æ–¥—ã–∂–∫–∞': '–ª–æ–¥—ã–∂–∫–∞',
      '–ª–æ–¥—ã–∂–∫–∏': '–ª–æ–¥—ã–∂–∫–∏',
      '–∑–∞–ø—è—Å—Ç—å–µ': '–∑–∞–ø—è—Å—Ç—å–µ',
      '–∑–∞–ø—è—Å—Ç—å—è': '–∑–∞–ø—è—Å—Ç—å—è',
      '–≤–µ–∑–¥–µ': '–≤–µ–∑–¥–µ',
      '–≤—Å—ë': '–≤—Å—ë'
    };
    
    // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—ã –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞
    this.pluralForms = {
      '–∑—É–±': '–∑—É–±—ã',
      '—É—Ö–æ': '—É—à–∏',
      '–Ω–æ–≥–∞': '–Ω–æ–≥–∏',
      '—Ä—É–∫–∞': '—Ä—É–∫–∏',
      '–≥–ª–∞–∑': '–≥–ª–∞–∑–∞',
      '–∫–æ–ª–µ–Ω–æ': '–∫–æ–ª–µ–Ω–∏',
      '–ª–æ–∫–æ—Ç—å': '–ª–æ–∫—Ç–∏',
      '–ø–ª–µ—á–æ': '–ø–ª–µ—á–∏',
      '–ª–æ–¥—ã–∂–∫–∞': '–ª–æ–¥—ã–∂–∫–∏',
      '–∑–∞–ø—è—Å—Ç—å–µ': '–∑–∞–ø—è—Å—Ç—å—è',
      '–ø–∞–ª–µ—Ü –Ω–æ–≥–∏': '–ø–∞–ª—å—Ü—ã –Ω–æ–≥',
      '–ø–∞–ª–µ—Ü —Ä—É–∫–∏': '–ø–∞–ª—å—Ü—ã —Ä—É–∫'
    };
  }

  getWordForm(card, context = {}) {
    if (!card) return '';
    
    const { type, text, forms } = card;
    
    // –î–ª—è –≤—Ä–µ–º–µ–Ω–∏ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
    if (type === 'time') {
      return text;
    }
    
    // –î–ª—è –º–µ—Å—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—ã
    if (type === 'place' && this.specialPlaceForms[text]) {
      return this.specialPlaceForms[text];
    }
    
    // –î–ª—è –±–æ–ª–∏ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å —Ç–µ–ª–∞ –±–µ–∑ –≥–ª–∞–≥–æ–ª–∞
    if (type === 'pain') {
      // –î–ª—è painConstruction –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å —Ç–µ–ª–∞
      if (context.painConstruction) {
        return this.painPatterns[text] || text;
      }
      
      // –î–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –∫–∞—Ä—Ç–æ—á–∫–∏
      return text;
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –≥–æ—Ç–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    if (context.preposition && forms && forms[context.preposition]) {
      return forms[context.preposition];
    }
    
    // –î–ª—è –ø—Ä—è–º—ã—Ö –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–π
    if (context.directObject) {
      if (forms && forms.direct) {
        return forms.direct;
      }
      return text;
    }
    
    return text || '';
  }

  // –£–ª—É—á—à–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  joinElements(elements, conjunction = '–∏') {
    if (!elements || elements.length === 0) return '';
    if (elements.length === 1) return elements[0];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ –ø—Ä–µ–¥–ª–æ–≥–∞
    const firstElement = elements[0];
    let commonPreposition = '';
    
    if (firstElement.startsWith('—Å ')) commonPreposition = '—Å ';
    else if (firstElement.startsWith('–≤ ')) commonPreposition = '–≤ ';
    else if (firstElement.startsWith('–Ω–∞ ')) commonPreposition = '–Ω–∞ ';
    
    // –ï—Å–ª–∏ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –ø—Ä–µ–¥–ª–æ–≥, –æ–±—ä–µ–¥–∏–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    const allSamePreposition = commonPreposition && 
      elements.every(el => el.startsWith(commonPreposition));
    
    if (allSamePreposition && commonPreposition) {
      // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥–ª–æ–≥–∏ —É –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
      const withoutPrepositions = elements.map(el => 
        el.substring(commonPreposition.length)
      );
      
      if (withoutPrepositions.length === 2) {
        return `${commonPreposition}${withoutPrepositions[0]} ${conjunction} ${withoutPrepositions[1]}`;
      }
      
      const last = withoutPrepositions.pop();
      return `${commonPreposition}${withoutPrepositions.join(', ')} ${conjunction} ${last}`;
    }
    
    // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä—è–º—ã–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–µ–∑ –ø—Ä–µ–¥–ª–æ–≥–æ–≤
    if (!elements.some(el => el.startsWith('—Å ') || el.startsWith('–≤ ') || el.startsWith('–Ω–∞ '))) {
      if (elements.length === 2) {
        return `${elements[0]} ${conjunction} ${elements[1]}`;
      }
      const last = elements.pop();
      return `${elements.join(', ')} ${conjunction} ${last}`;
    }
    
    // –°–º–µ—à–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    if (elements.length === 2) {
      return `${elements[0]} ${conjunction} ${elements[1]}`;
    }
    
    const last = elements.pop();
    return `${elements.join(', ')} ${conjunction} ${last}`;
  }

  // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ñ—Ä–∞–∑—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –±–æ–ª–∏
  buildPhrase(phrase) {
    if (!phrase.action) return '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ';
    
    const action = phrase.action;
    const actionId = action.id;
    const actionRule = this.actionRules[actionId] || {};
    const metadata = action.metadata || {};
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ç—Ä–µ–±—É–µ—Ç –ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ –∂–µ–ª–∞–Ω–∏–µ
    const requiresDesire = actionRule.requiresDesire || metadata.requiresDesire;
    const isStandalone = actionRule.standalone || metadata.isStandalone;
    const isDirectObject = actionRule.directObject || metadata.directObject;
    const requiresSubject = actionRule.requiresSubject !== false;
    const isPainConstruction = actionRule.painConstruction || metadata.painConstruction;
    const requiresPainObject = actionRule.requiresPainObject;
    
    // –î–ª—è –±–æ–ª–∏ - —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    if (isPainConstruction) {
      return this.buildPainPhrase(phrase);
    }
    
    // –î–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ (—ç–º–æ—Ü–∏–∏, –æ–±—É—á–µ–Ω–∏–µ, –¥–∏–∞–ª–æ–≥)
    if (isStandalone) {
      if (phrase.subject && requiresSubject) {
        return `${phrase.subject} ${phrase.action.text}`;
      }
      return phrase.action.text;
    }
    
    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ñ—Ä–∞–∑—ã
    const parts = [];
    const subject = phrase.subject || (requiresSubject ? '–Ø' : '');
    if (subject) parts.push(subject);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∂–µ–ª–∞–Ω–∏–µ
    if (phrase.desire) {
      parts.push(phrase.desire);
    } else if (requiresDesire && !isStandalone) {
      parts.push('—Ö–æ—á—É');
    }
    
    parts.push(action.text);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –¥–µ–π—Å—Ç–≤–∏—è
    if (actionId === 'ACT-PET') {
      // –î–ª—è "–≥–ª–∞–¥–∏—Ç—å" - –ø—Ä—è–º–æ–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ pets
      if (phrase.pets && phrase.pets.length > 0) {
        const pets = phrase.pets.map(pet => 
          this.getWordForm(pet, { directObject: true })
        );
        parts.push(this.joinElements(pets));
      }
    }
    else if (actionId === 'ACT-WEAR') {
      // –î–ª—è "–æ–¥–µ–≤–∞—Ç—å—Å—è" - –ø—Ä–µ–¥–ª–æ–≥ "–≤" + –≤–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂
      if (phrase.objects && phrase.objects.length > 0) {
        const clothing = phrase.objects.map(item => {
          if (item.forms && item.forms['–≤']) {
            return `–≤ ${item.forms['–≤']}`;
          }
          return `–≤ ${item.text}`;
        });
        parts.push(this.joinElements(clothing));
      }
    }
    else if (actionId === 'ACT-UNDRESS') {
      // –î–ª—è "—Å–Ω—è—Ç—å" - –ø—Ä—è–º–æ–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
      if (phrase.objects && phrase.objects.length > 0) {
        const clothing = phrase.objects.map(item => {
          if (item.forms && item.forms['direct']) {
            return item.forms['direct'];
          }
          return item.text;
        });
        parts.push(this.joinElements(clothing));
      }
    }
    else if (actionId === 'ACT-RIDE') {
      // –î–ª—è "–∫–∞—Ç–∞—Ç—å—Å—è" - –ø—Ä–µ–¥–ª–æ–≥ "–Ω–∞" + –ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π –ø–∞–¥–µ–∂
      if (phrase.objects && phrase.objects.length > 0) {
        const transport = phrase.objects.map(item => {
          if (item.forms && item.forms['–Ω–∞']) {
            return `–Ω–∞ ${item.forms['–Ω–∞']}`;
          }
          return `–Ω–∞ ${item.text}`;
        });
        parts.push(this.joinElements(transport));
      }
    }
    else if (actionId === 'ACT-EAT' || actionId === 'ACT-DRINK') {
      // –î–ª—è "–µ—Å—Ç—å" –∏ "–ø–∏—Ç—å" - –ø—Ä—è–º–æ–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
      if (phrase.objects && phrase.objects.length > 0) {
        const items = phrase.objects.map(item => 
          this.getWordForm(item, { directObject: true })
        );
        parts.push(this.joinElements(items));
      }
    }
    else if (actionId === 'ACT-PLAY') {
      // –î–ª—è "–∏–≥—Ä–∞—Ç—å" - –ø—Ä–µ–¥–ª–æ–≥ "—Å" + —Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂
      if (phrase.objects && phrase.objects.length > 0) {
        const toys = phrase.objects.map(toy => {
          if (toy.forms && toy.forms['—Å']) {
            return `—Å ${toy.forms['—Å']}`;
          }
          return `—Å ${toy.text}`;
        });
        parts.push(this.joinElements(toys));
      }
    }
    else if (actionId === 'ACT-WASH-HANDS' || actionId === 'ACT-BRUSH-TEETH') {
      // –î–ª—è –≥–∏–≥–∏–µ–Ω—ã - –ø—Ä–µ–¥–ª–æ–≥ "—Å" + —Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂
      if (phrase.objects && phrase.objects.length > 0) {
        const tools = phrase.objects.map(tool => {
          if (tool.forms && tool.forms['—Å']) {
            return `—Å ${tool.forms['—Å']}`;
          }
          return `—Å ${tool.text}`;
        });
        parts.push(this.joinElements(tools));
      }
    }
    else if (isStandalone) {
      // –î–ª—è standalone –¥–µ–π—Å—Ç–≤–∏–π –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –∫—Ä–æ–º–µ –≤—Ä–µ–º–µ–Ω–∏
    }
    
    // –õ—é–¥–∏ —Å –ø—Ä–µ–¥–ª–æ–≥–æ–º "—Å"
    if (!isStandalone && phrase.people && phrase.people.length > 0) {
      const people = phrase.people.map(person => {
        if (person.forms && person.forms['—Å']) {
          return `—Å ${person.forms['—Å']}`;
        }
        return `—Å ${person.text}`;
      });
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –ø—Ä–µ–¥–ª–æ–≥–æ–º "—Å"
      const lastPart = parts[parts.length - 1];
      if (lastPart && lastPart.startsWith('—Å ')) {
        const combined = this.joinElements([lastPart, ...people]);
        parts[parts.length - 1] = combined;
      } else {
        parts.push(this.joinElements(people));
      }
    }
    
    // –ú–µ—Å—Ç–∞
    if (!isStandalone && phrase.places && phrase.places.length > 0) {
      const place = phrase.places[0];
      const placeForm = this.getWordForm(place);
      parts.push(placeForm);
    }
    
    // –í—Ä–µ–º—è
    if (phrase.time) {
      parts.push(this.getWordForm(phrase.time));
    }
    
    return parts.join(' ');
  }

  // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è —Ñ—Ä–∞–∑ –æ –±–æ–ª–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô)
  buildPainPhrase(phrase) {
    const parts = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ª–µ–∂–∞—â–µ–µ
    if (phrase.subject) {
      parts.push(phrase.subject);
    } else {
      parts.push('–£ –º–µ–Ω—è');
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–∞–≥–æ–ª –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–µ–π—Å—Ç–≤–∏—è
    let verb = phrase.action ? phrase.action.text : '–±–æ–ª–∏—Ç';
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–±—ä–µ–∫—Ç –±–æ–ª–∏, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–æ—Ä–º—É –≥–ª–∞–≥–æ–ª–∞
    if (phrase.objects && phrase.objects.length > 0) {
      const painObject = phrase.objects[0];
      const isPlural = this.isPluralPain(painObject.text);
      
      // –ú–µ–Ω—è–µ–º –≥–ª–∞–≥–æ–ª –Ω–∞ "–±–æ–ª—è—Ç" –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞
      if (isPlural && verb === '–±–æ–ª–∏—Ç') {
        verb = '–±–æ–ª—è—Ç';
      } else if (isPlural && verb === '—Å–∏–ª—å–Ω–æ –±–æ–ª–∏—Ç') {
        verb = '—Å–∏–ª—å–Ω–æ –±–æ–ª—è—Ç';
      }
    }
    
    parts.push(verb);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Å—Ç—å —Ç–µ–ª–∞ (—Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å —Ç–µ–ª–∞, –±–µ–∑ –≥–ª–∞–≥–æ–ª–∞)
    if (phrase.objects && phrase.objects.length > 0) {
      const painObject = phrase.objects[0];
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º painConstruction: true, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å —Ç–µ–ª–∞
      const painWord = this.getWordForm(painObject, { painConstruction: true });
      parts.push(painWord);
    } else {
      parts.push('—á—Ç–æ-—Ç–æ');
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (phrase.time) {
      parts.push(this.getWordForm(phrase.time));
    }
    
    return parts.join(' ');
  }

  // –ú–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –¥–µ–π—Å—Ç–≤–∏–µ–º
  isObjectCompatible(action, object) {
    if (!action || !object) return false;
    
    const actionRule = this.actionRules[action.id] || {};
    
    // –î–ª—è –±–æ–ª–∏ - —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–∏–ø–∞ pain
    if (actionRule.painConstruction) {
      return object.type === 'pain';
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã –æ–±—ä–µ–∫—Ç–æ–≤
    const allowedStores = actionRule.allowedStores || [];
    const objectRule = this.rules[object.type] || {};
    const storeIn = objectRule.storeIn;
    
    if (allowedStores.length > 0 && storeIn) {
      return allowedStores.includes(storeIn);
    }
    
    return true;
  }

  // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ñ–æ—Ä–º –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ –±–æ–ª–∏
  getPainPattern(painText, isPlural = false) {
    if (isPlural) {
      const pluralForm = this.pluralForms[painText];
      if (pluralForm) {
        return this.painPatterns[pluralForm] || pluralForm;
      }
      return painText;
    }
    return this.painPatterns[painText] || painText;
  }

  // –ú–µ—Ç–æ–¥ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞
  isPluralPain(painText) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —Ç–µ–∫—Å—Ç—É
    const pluralForms = [
      '–∑—É–±—ã', '—É—à–∏', '–Ω–æ–≥–∏', '—Ä—É–∫–∏', '–≥–ª–∞–∑–∞', '–∫–æ–ª–µ–Ω–∏', '–ª–æ–∫—Ç–∏', '–ø–ª–µ—á–∏', '–ª–æ–¥—ã–∂–∫–∏', '–∑–∞–ø—è—Å—Ç—å—è',
      '–ø–∞–ª—å—Ü—ã –Ω–æ–≥', '–ø–∞–ª—å—Ü—ã —Ä—É–∫'
    ];
    
    return pluralForms.includes(painText);
  }
}

    const FALLBACK_CARDS = {
  "cards": {
}
};

    class Communicator {
      constructor() {
        this.currentPhrase = {
          subject: null,
          desire: null,
          action: null,
          people: [],
          pets: [],
          places: [],
          objects: [],
          time: null
        };
        
        this.cards = {};
        this.navigationStack = [];
        this.currentView = 'categories';
        this.childInfo = this.loadChildInfo();
        this.filterMode = null;
        this.currentTab = 'main';
        this.isQuickNavMode = false;
        this.currentReplacement = null;
        this.grammar = new AdvancedGrammarSystem();
        
        this.nextReplacementIndex = {
          people: 0,
          places: 0,
          objects: 0
        };
        
        this.tabNavigationStacks = {
          'emotions': [],
          'learning': [],
          'dialog': []
        };
        
        this.tabCurrentViews = {
          'emotions': 'categories',
          'learning': 'categories',
          'dialog': 'categories'
        };
        
        this.initializeCards().then(() => {
          this.init();
          this.initTabs();
          this.initPinSystem();
          this.loadAllData();
          this.updateSystemInfo();
        });

        this.cardTypeHandlers = {
          'action': this.handleActionSelection.bind(this),
          'emotion': this.handleEmotionSelection.bind(this),
          'person': this.handlePersonSelection.bind(this),
          'pet': this.handlePetSelection.bind(this),
          'place': this.handlePlaceSelection.bind(this),
          'object': this.handleObjectSelection.bind(this),
          'clothing': this.handleObjectSelection.bind(this),
          'book': this.handleObjectSelection.bind(this),
          'creative': this.handleObjectSelection.bind(this),
          'pain': this.handlePainSelection.bind(this),
          'time': this.handleTimeSelection.bind(this),
          'learning': this.handleLearningSelection.bind(this),
          'help': this.handleActionSelection.bind(this),
          'request': this.handleActionSelection.bind(this),
          'dialog': this.handleDialogSelection.bind(this),
          'color': this.handleLearningSelection.bind(this)
        };
      }

      async initializeCards() {
        const savedCards = localStorage.getItem('communicatorCards');
        
        if (savedCards) {
          try {
            const parsed = JSON.parse(savedCards);
            this.cards = parsed.cards || parsed;
            console.log('–ö–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage');
            return;
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑ localStorage:', e);
          }
        }
        
        this.cards = FALLBACK_CARDS.cards;
        console.log('–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è fallback –∫–∞—Ä—Ç–æ—á–∫–∏');
      }

      async loadCardsFromRemote() {
        try {
          console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞...');
          const response = await fetch(REMOTE_CARDS_URL);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.cards) {
            this.cards = data.cards;
            this.saveCards();
            
            this.navigateToHome();
            this.renderCategories();
            this.updateUI();
            this.updateSystemInfo();
            
            console.log('–ö–∞—Ä—Ç–æ—á–∫–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞');
            alert('–ö–∞—Ä—Ç–æ—á–∫–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞!');
            return true;
          } else {
            throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞:', error);
          alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞: ${error.message}`);
          return false;
        }
      }

async loadCardsWithOptions() {
  const modal = document.getElementById('remoteLoadModal');
  modal.style.display = 'flex';
  
  // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
  document.querySelector('input[name="loadStrategy"][value="replace"]').checked = true;
  document.querySelectorAll('input[name="section"]').forEach(cb => {
    cb.checked = cb.value === '–ì–ª–∞–≤–Ω–∞—è';
  });
  document.getElementById('skipCategories').checked = false;
  document.getElementById('preserveExisting').checked = false;
  document.getElementById('sectionsSelection').style.display = 'none';
  document.getElementById('summaryInfo').style.display = 'none';
}

async confirmRemoteLoad() {
  const modal = document.getElementById('remoteLoadModal');
  const strategy = document.querySelector('input[name="loadStrategy"]:checked').value;
  const selectedSections = Array.from(document.querySelectorAll('input[name="section"]:checked'))
    .map(cb => cb.value);
  const skipCategories = document.getElementById('skipCategories').checked;
  const preserveExisting = document.getElementById('preserveExisting').checked;
  
  if (strategy === 'sections' && selectedSections.length === 0) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞–∑–¥–µ–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏!');
    return;
  }
  
  modal.style.display = 'none';
  
  try {
    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞...');
    const response = await fetch(REMOTE_CARDS_URL);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.cards) {
      throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á "cards"');
    }
    
    const remoteCards = data.cards;
    const result = await this.processRemoteCards(remoteCards, {
      strategy,
      selectedSections,
      skipCategories,
      preserveExisting
    });
    
    this.saveCards();
    this.navigateToHome();
    this.renderCategories();
    this.updateUI();
    this.updateSystemInfo();
    
    alert(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!\n–ù–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫: ${result.new}\n–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${result.updated}\n–í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫: ${Object.keys(this.cards).length}`);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞:', error);
    alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞: ${error.message}`);
  }
}

processRemoteCards(remoteCards, options) {
  const stats = { new: 0, updated: 0, skipped: 0 };
  
  switch (options.strategy) {
    case 'replace':
      // –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞
      this.cards = remoteCards;
      stats.new = Object.keys(remoteCards).length;
      break;
      
    case 'merge':
      // –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
      for (const [id, card] of Object.entries(remoteCards)) {
        if (!this.cards[id]) {
          this.cards[id] = card;
          stats.new++;
        } else {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
          this.cards[id] = { ...this.cards[id], ...card };
          stats.updated++;
        }
      }
      break;
      
    case 'sections':
      // –í—ã–±–æ—Ä–æ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º
      this.selectiveLoad(remoteCards, options, stats);
      break;
  }
  
  console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', stats);
  return stats;
}

selectiveLoad(remoteCards, options, stats) {
  const { selectedSections, skipCategories, preserveExisting } = options;
  
  // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é —Ç–µ–∫—É—â–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ–≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã
  let newCards = preserveExisting ? { ...this.cards } : {};
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
  for (const [id, card] of Object.entries(remoteCards)) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ä–∞–∑–¥–µ–ª–∞–º
    const hasSelectedSection = card.sections && 
      card.sections.some(section => selectedSections.includes(section));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const isCategory = card.type === 'category';
    
    if (hasSelectedSection && (!skipCategories || !isCategory)) {
      // –î–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
      if (!newCards[id]) {
        newCards[id] = card;
        stats.new++;
      } else {
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–∞–∑–¥–µ–ª—ã —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–æ–π
        if (card.sections && newCards[id].sections) {
          const mergedSections = [...new Set([...newCards[id].sections, ...card.sections])];
          newCards[id] = { ...newCards[id], ...card, sections: mergedSections };
        } else {
          newCards[id] = { ...newCards[id], ...card };
        }
        stats.updated++;
      }
    } else if (preserveExisting && this.cards[id]) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ –Ω–µ–≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
      newCards[id] = this.cards[id];
      stats.skipped++;
    }
  }
  
  this.cards = newCards;
}

// –ú–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
previewRemoteLoad() {
  const strategy = document.querySelector('input[name="loadStrategy"]:checked').value;
  const selectedSections = Array.from(document.querySelectorAll('input[name="section"]:checked'))
    .map(cb => cb.value);
  const skipCategories = document.getElementById('skipCategories').checked;
  
  const summary = document.getElementById('summaryInfo');
  const counts = document.getElementById('sectionCounts');
  
  if (strategy === 'sections') {
    if (selectedSections.length === 0) {
      summary.style.display = 'none';
      return;
    }
    
    let sectionText = selectedSections.map(s => {
      switch(s) {
        case '–ì–ª–∞–≤–Ω–∞—è': return 'üì± –ì–ª–∞–≤–Ω–∞—è';
        case '–û–±—É—á–µ–Ω–∏–µ': return 'üéì –û–±—É—á–µ–Ω–∏–µ';
        case '–î–∏–∞–ª–æ–≥': return 'üí¨ –î–∏–∞–ª–æ–≥';
        case '–≠–º–æ—Ü–∏–∏': return 'üòä –≠–º–æ—Ü–∏–∏';
        default: return s;
      }
    }).join(', ');
    
    counts.textContent = `${selectedSections.length} —Ä–∞–∑–¥–µ–ª–æ–≤: ${sectionText}`;
    if (skipCategories) {
      counts.textContent += ' (–±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π)';
    }
    summary.style.display = 'block';
  } else {
    summary.style.display = 'none';
  }
}

      loadChildInfo() {
        const saved = localStorage.getItem('childInfo');
        return saved ? JSON.parse(saved) : {
          name: '',
          age: '',
          gender: '',
          birthDate: '',
          motherPhone: '',
          fatherPhone: '',
          parentEmail: '',
          address: '',
          doctorPhone: '',
          diagnosis: '',
          allergies: '',
          medications: '',
          specialNeeds: '',
          interests: '',
          dislikes: '',
          sensoryPreferences: 'visual',
          difficultyLevel: 'medium'
        };
      }

      init() {
        this.applyFontSettings();
        this.bindEvents();
        this.renderCategories();
        this.updateUI();
      }

      applyFontSettings() {
        document.documentElement.style.setProperty('--font-scale', fontSizeScale);
        document.documentElement.style.setProperty('--base-font-size', (16 * fontSizeScale) + 'px');
      }

      initTabs() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const tabId = btn.getAttribute('data-tab');
            this.currentTab = tabId;
            
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(tabId).classList.add('active');

            this.switchButtons(tabId);
            this.loadTabData(tabId);
          });
        });
        
        this.switchButtons(this.currentTab);
      }

      switchButtons(tabId) {
        const mainButtons = document.getElementById('mainButtonsContainer');
        const learningButtons = document.getElementById('learningButtonsContainer');
        const dialogButtons = document.getElementById('dialogButtonsContainer');

        mainButtons.style.display = 'none';
        learningButtons.style.display = 'none';
        dialogButtons.style.display = 'none';

        switch(tabId) {
          case 'main':
            mainButtons.style.display = 'block';
            break;
          case 'learning':
            learningButtons.style.display = 'block';
            break;
          case 'dialog':
            dialogButtons.style.display = 'block';
            break;
        }
      }

      initPinSystem() {
        const pinBtns = document.querySelectorAll('.pin-btn');
        const pinInput = document.getElementById('pinInput');
        const pinOverlay = document.getElementById('pinOverlay');
        const pinCancel = document.getElementById('pinCancel');

        pinBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const value = btn.getAttribute('data-pin');
            if (value === 'clear') {
              pinInput.value = '';
            } else if (value === 'enter') {
              this.checkPin(pinInput.value);
            } else {
              if (pinInput.value.length < 4) {
                pinInput.value += value;
              }
            }
          });
        });

        pinCancel.addEventListener('click', () => {
          pinOverlay.style.display = 'none';
          pinInput.value = '';
          pinAction = null;
        });

        document.addEventListener('keydown', (e) => {
          if (pinOverlay.style.display === 'block') {
            if (e.key >= '0' && e.key <= '9') {
              if (pinInput.value.length < 4) {
                pinInput.value += e.key;
              }
              e.preventDefault();
            } else if (e.key === 'Enter') {
              this.checkPin(pinInput.value);
              e.preventDefault();
            } else if (e.key === 'Backspace' || e.key === 'Delete') {
              pinInput.value = pinInput.value.slice(0, -1);
              e.preventDefault();
            } else if (e.key === 'Escape') {
              pinOverlay.style.display = 'none';
              pinInput.value = '';
              pinAction = null;
              e.preventDefault();
            }
          }
        });
      }

      checkPin(enteredPin) {
        const pinOverlay = document.getElementById('pinOverlay');
        if (enteredPin === currentPin) {
          isEditingEnabled = true;
          pinOverlay.style.display = 'none';
          document.getElementById('pinInput').value = '';
          if (pinAction === 'editChild') {
            this.enableChildEditing();
          }
        } else {
          alert("–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥!");
          document.getElementById('pinInput').value = '';
        }
        pinAction = null;
      }

      showPinModal(action) {
        pinAction = action;
        document.getElementById('pinInput').value = '';
        document.getElementById('pinOverlay').style.display = 'flex';
      }

      loadTabData(tabId) {
        switch(tabId) {
          case 'main':
            this.switchButtons('main');
            break;
          case 'child':
            this.renderChildInfo(false);
            break;
          case 'emotions':
            this.renderEmotionsTab();
            break;
          case 'learning':
            this.renderLearningTab();
            break;
          case 'dialog':
            this.renderDialogTab();
            break;
          case 'history':
            this.renderHistory();
            break;
          case 'settings':
            this.updateSystemInfo();
            break;
        }
      }

      loadAllData() {
        this.renderChildInfo(false);
        this.renderEmotionsTab();
      }

	    addGrammarRule(cardType, rule) {
    this.grammar.addRule(cardType, rule);
  }
  
  addActionGrammarRule(actionId, rule) {
    this.grammar.addActionRule(actionId, rule);
  }

      saveCards() {
        const dataToSave = { cards: this.cards };
        localStorage.setItem('communicatorCards', JSON.stringify(dataToSave));
        this.updateSystemInfo();
      }

      resetCards() {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏.")) {
          this.cards = FALLBACK_CARDS.cards;
          this.saveCards();
          this.navigateToHome();
          this.renderCategories();
          this.updateSystemInfo();
          alert("–ö–∞—Ä—Ç–æ—á–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º!");
        }
      }

      exportCards() {
        const dataStr = JSON.stringify({ cards: this.cards }, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = 'communicator_cards_' + new Date().toISOString().slice(0,10) + '.json';
        link.click();
      }

      importCards(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const importedData = JSON.parse(e.target.result);
            if (importedData.cards) {
              if (confirm("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏? –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.")) {
                this.cards = importedData.cards;
                this.saveCards();
                this.navigateToHome();
                this.renderCategories();
                this.updateSystemInfo();
                alert("–ö–∞—Ä—Ç–æ—á–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!");
              }
            } else {
              alert("–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∏.");
            }
          } catch (error) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∫–∞—Ä—Ç–æ—á–µ–∫: " + error.message);
          }
        };
        reader.readAsText(file);
        event.target.value = '';
      }

      bindEvents() {
        document.getElementById('btnI').addEventListener('click', () => {
          this.setSubject('–Ø');
        });

        document.getElementById('btnWant').addEventListener('click', () => {
          this.setDesire('–•–æ—á—É');
        });

        document.getElementById('btnDontWant').addEventListener('click', () => {
          this.setDesire('–ù–µ —Ö–æ—á—É');
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
          this.clearPhrase();
        });

        document.getElementById('btnDontUnderstand').addEventListener('click', () => {
          this.speakText('–Ø –Ω–µ –ø–æ–Ω–∏–º–∞—é');
        });

        document.getElementById('btnFoundError').addEventListener('click', () => {
          this.speakText('–ù–∞—à–µ–ª –æ—à–∏–±–∫—É');
        });

        document.getElementById('btnExplainMe').addEventListener('click', () => {
          this.speakText('–û–±—ä—è—Å–Ω–∏—Ç–µ –º–Ω–µ');
        });

        document.getElementById('btnYes').addEventListener('click', () => {
          this.speakText('–î–∞');
        });

        document.getElementById('btnNo').addEventListener('click', () => {
          this.speakText('–ù–µ—Ç');
        });

        document.getElementById('btnDontKnow').addEventListener('click', () => {
          this.speakText('–ù–µ –∑–Ω–∞—é');
        });

        document.getElementById('backBtn').addEventListener('click', () => {
          this.navigateBack();
        });

        document.getElementById('homeBtn').addEventListener('click', () => {
          this.navigateToHome();
        });

        document.getElementById('actionsBtn').addEventListener('click', () => {
          this.showAllActions();
        });

        document.getElementById('doneBtn').addEventListener('click', () => {
          this.finishQuickNav();
        });

        document.getElementById('backBtnEmotions').addEventListener('click', () => {
          this.navigateBackTab('emotions');
        });

        document.getElementById('homeBtnEmotions').addEventListener('click', () => {
          this.navigateToHomeTab('emotions');
        });

        document.getElementById('backBtnLearning').addEventListener('click', () => {
          this.navigateBackTab('learning');
        });

        document.getElementById('homeBtnLearning').addEventListener('click', () => {
          this.navigateToHomeTab('learning');
        });

        document.getElementById('backBtnDialog').addEventListener('click', () => {
          this.navigateBackTab('dialog');
        });

        document.getElementById('homeBtnDialog').addEventListener('click', () => {
          this.navigateToHomeTab('dialog');
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
          this.exportCards();
        });

        document.getElementById('importBtn').addEventListener('click', () => {
          document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
          this.importCards(e);
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
          this.resetCards();
        });

document.getElementById('remoteLoadBtn').addEventListener('click', () => {
  this.loadCardsWithOptions();
});

// –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏
document.getElementById('confirmRemoteLoad').addEventListener('click', () => {
  this.confirmRemoteLoad();
});

document.getElementById('cancelRemoteLoad').addEventListener('click', () => {
  document.getElementById('remoteLoadModal').style.display = 'none';
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
document.querySelectorAll('input[name="loadStrategy"]').forEach(radio => {
  radio.addEventListener('change', () => {
    const sectionsDiv = document.getElementById('sectionsSelection');
    if (radio.value === 'sections') {
      sectionsDiv.style.display = 'block';
      this.previewRemoteLoad();
    } else {
      sectionsDiv.style.display = 'none';
      document.getElementById('summaryInfo').style.display = 'none';
    }
  });
});

document.querySelectorAll('input[name="section"], #skipCategories, #preserveExisting').forEach(input => {
  input.addEventListener('change', () => {
    this.previewRemoteLoad();
  });
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.getElementById('remoteLoadModal').addEventListener('click', (e) => {
  if (e.target.id === 'remoteLoadModal') {
    document.getElementById('remoteLoadModal').style.display = 'none';
  }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && document.getElementById('remoteLoadModal').style.display === 'flex') {
    document.getElementById('remoteLoadModal').style.display = 'none';
  }
});

        document.getElementById('editorBtn').addEventListener('click', () => {
          window.open(EDITOR_URL, '_blank');
        });

document.getElementById('editorBtnFromInstructions').addEventListener('click', () => {
  window.open(EDITOR_URL, '_blank');
});

        document.getElementById('speakBtn').addEventListener('click', () => {
          this.speakPhrase();
        });

        document.getElementById('quickPeopleBtn').addEventListener('click', () => {
          this.showFilteredPeople();
        });

        document.getElementById('quickPlacesBtn').addEventListener('click', () => {
          this.showFilteredPlaces();
        });

        document.getElementById('quickObjectsBtn').addEventListener('click', () => {
          this.showFilteredObjects();
        });

        document.getElementById('quickTimeBtn').addEventListener('click', () => {
          this.showFilteredTime();
        });

        document.getElementById('editChildBtn').addEventListener('click', () => {
          this.showPinModal('editChild');
        });

        document.getElementById('emergencyHelp').addEventListener('click', () => this.handleEmergency('help'));
        document.getElementById('emergencyPain').addEventListener('click', () => this.handleEmergency('pain'));
        document.getElementById('emergencyScared').addEventListener('click', () => this.handleEmergency('scared'));
        document.getElementById('emergencySick').addEventListener('click', () => this.handleEmergency('sick'));
        document.getElementById('emergencyLost').addEventListener('click', () => this.handleEmergency('lost'));
        document.getElementById('emergencyCall').addEventListener('click', () => this.handleEmergency('call'));
        document.getElementById('emergencyStop').addEventListener('click', () => this.handleEmergency('stop'));

        document.getElementById('speedSlider').addEventListener('input', (e) => {
          document.getElementById('speedValue').textContent = e.target.value;
          speechRate = parseFloat(e.target.value);
          localStorage.setItem('speech_rate', speechRate);
        });

        document.getElementById('fontSizeSlider').addEventListener('input', (e) => {
          const value = e.target.value;
          document.getElementById('fontSizeValue').textContent = value + '%';
          fontSizeScale = value / 100;
          localStorage.setItem('font_size_scale', fontSizeScale);
          this.applyFontSettings();
        });

        document.getElementById('changePinBtn').addEventListener('click', () => {
          this.changePinWithVerification();
        });

        document.getElementById('voiceSelect').addEventListener('change', (e) => {
          selectedVoice = voices.find(v => v.name === e.target.value);
          localStorage.setItem('selected_voice', e.target.value || '');
        });

        document.getElementById('clearHistoryBtn').addEventListener('click', () => {
          this.clearHistory();
        });

        document.getElementById('exportHistoryBtn').addEventListener('click', () => {
          this.exportHistory();
        });
      }

      changePinWithVerification() {
        const currentPinInput = document.getElementById('currentPin').value;
        const newPin = document.getElementById('newPin').value;
        const confirmPin = document.getElementById('confirmPin').value;
        
        if (!currentPinInput) {
          alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π PIN-–∫–æ–¥');
          return;
        }
        
        if (currentPinInput !== currentPin) {
          alert('–¢–µ–∫—É—â–∏–π PIN-–∫–æ–¥ –Ω–µ–≤–µ—Ä–µ–Ω');
          document.getElementById('currentPin').value = '';
          return;
        }
        
        if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
          alert('–ù–æ–≤—ã–π PIN-–∫–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 4 —Ü–∏—Ñ—Ä');
          return;
        }
        
        if (newPin !== confirmPin) {
          alert('–ù–æ–≤—ã–π PIN-–∫–æ–¥ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
          return;
        }
        
        currentPin = newPin;
        localStorage.setItem('communicator_pin', currentPin);
        
        document.getElementById('currentPin').value = '';
        document.getElementById('newPin').value = '';
        document.getElementById('confirmPin').value = '';
        
        alert('PIN-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω');
        this.updateSystemInfo();
      }

      speakText(text) {
        if ('speechSynthesis' in window) {
          speechSynthesis.cancel();
          
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'ru-RU';
          utterance.rate = speechRate;
          utterance.pitch = 1.1;
          
          if (selectedVoice) {
            utterance.voice = selectedVoice;
          }
          
          if (speechSynthesis.speaking) {
            speechSynthesis.resume();
          }
          
          utterance.onstart = () => {
            console.log('–ù–∞—á–∞–ª–æ –æ–∑–≤—É—á–∫–∏:', text);
          };
          
          utterance.onend = () => {
            console.log('–û–∫–æ–Ω—á–∞–Ω–∏–µ –æ–∑–≤—É—á–∫–∏');
          };
          
          utterance.onerror = (event) => {
            console.error('–û—à–∏–±–∫–∞ –æ–∑–≤—É—á–∫–∏:', event);
          };
          
          speechSynthesis.speak(utterance);
          
          this.addToHistory(text);
        } else {
          console.warn('Speech synthesis not supported');
        }
      }

      showAllActions() {
        this.isQuickNavMode = false;
        this.filterMode = 'actions';
        this.navigationStack.push('ALL-ACTIONS');
        this.renderCards();
        this.toggleBackButton();
        this.showCardsView();
        this.hideDoneButton();
      }

      showFilteredPeople() {
        this.isQuickNavMode = true;
        this.filterMode = 'people';
        this.navigationStack.push('FILTER-PEOPLE');
        this.renderCards();
        this.toggleBackButton();
        this.showCardsView();
        this.showDoneButton();
      }

      showFilteredPlaces() {
        this.isQuickNavMode = true;
        this.filterMode = 'places';
        this.navigationStack.push('FILTER-PLACES');
        this.renderCards();
        this.toggleBackButton();
        this.showCardsView();
        this.showDoneButton();
      }

      showFilteredObjects() {
        if (!this.currentPhrase.action) return;
        
        this.isQuickNavMode = true;
        this.filterMode = 'actionObjects';
        this.navigationStack.push('FILTER-OBJECTS');
        this.renderCards();
        this.toggleBackButton();
        this.showCardsView();
        this.showDoneButton();
      }

      showFilteredTime() {
        this.isQuickNavMode = true;
        this.filterMode = 'time';
        this.navigationStack.push('FILTER-TIME');
        this.renderCards();
        this.toggleBackButton();
        this.showCardsView();
        this.showDoneButton();
      }

      showDoneButton() {
        document.getElementById('doneBtn').classList.add('visible');
      }

      hideDoneButton() {
        document.getElementById('doneBtn').classList.remove('visible');
      }

      finishQuickNav() {
        this.navigateBack();
        this.isQuickNavMode = false;
      }

      handleActionSelection(card) {
        const oldAction = this.currentPhrase.action;
        this.currentPhrase.action = card;
        
        this.checkAndResetIncompatibleElements(oldAction, card);
        
        if (card.metadata && card.metadata.isStandalone) {
          this.currentPhrase.people = [];
          this.currentPhrase.pets = [];
          this.currentPhrase.places = [];
          this.currentPhrase.objects = [];
        }
      }

      handleDialogSelection(card) {
        this.speakText(card.text);
      }

      handleLearningSelection(card) {
        this.speakText(card.text);
      }

      handleEmotionSelection(card) {
        if (this.currentTab === 'main') {
          this.currentPhrase.subject = '–Ø';
          this.currentPhrase.desire = null;
          this.currentPhrase.action = card;
          this.currentPhrase.people = [];
          this.currentPhrase.pets = [];
          this.currentPhrase.places = [];
          this.currentPhrase.objects = [];
          this.currentPhrase.time = null;
          this.updateUI();
        } else {
          this.speakText(card.text);
        }
      }

      handlePersonSelection(card) {
        if (!this.currentPhrase.action || !this.currentPhrase.action.metadata) return;
        
        const metadata = this.currentPhrase.action.metadata;
        const allowedWith = metadata.allowedWith || [];
        const maxPeople = metadata.maxPeople || 0;
        
        if (!allowedWith.includes('people')) return;
        
        const existingIndex = this.currentPhrase.people.findIndex(p => p.id === card.id);
        if (existingIndex !== -1) {
          this.currentPhrase.people.splice(existingIndex, 1);
          this.updateUI();
          return;
        }
        
        if (maxPeople === 0 || this.currentPhrase.people.length < maxPeople) {
          this.currentPhrase.people.push(card);
        } else if (maxPeople > 0) {
          const replaceIndex = this.nextReplacementIndex.people;
          this.currentPhrase.people[replaceIndex] = card;
          this.nextReplacementIndex.people = (replaceIndex + 1) % maxPeople;
        }
      }

handlePetSelection(card) {
  if (!this.currentPhrase.action || !this.currentPhrase.action.metadata) return;
  
  const metadata = this.currentPhrase.action.metadata;
  const allowedWith = metadata.allowedWith || [];
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –ø–∏—Ç–æ–º—Ü–µ–≤ –∫ —ç—Ç–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é
  if (!allowedWith.includes('pets')) return;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –ø–∏—Ç–æ–º–µ—Ü
  const existingIndex = this.currentPhrase.pets.findIndex(p => p.id === card.id);
  if (existingIndex !== -1) {
    this.currentPhrase.pets.splice(existingIndex, 1);
  } else {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    const maxPets = metadata.maxPets || 0;
    if (maxPets === 0 || this.currentPhrase.pets.length < maxPets) {
      this.currentPhrase.pets.push(card);
    }
  }
  
  this.updateUI();
}

      handlePlaceSelection(card) {
        if (!this.currentPhrase.action || !this.currentPhrase.action.metadata) return;
        
        const metadata = this.currentPhrase.action.metadata;
        const allowedWith = metadata.allowedWith || [];
        const maxPlaces = metadata.maxPlaces || 0;
        
        if (!allowedWith.includes('places')) return;
        
        const existingIndex = this.currentPhrase.places.findIndex(p => p.id === card.id);
        if (existingIndex !== -1) {
          this.currentPhrase.places.splice(existingIndex, 1);
          this.updateUI();
          return;
        }
        
        if (maxPlaces === 0 || this.currentPhrase.places.length < maxPlaces) {
          this.currentPhrase.places.push(card);
        } else if (maxPlaces > 0) {
          const replaceIndex = this.nextReplacementIndex.places;
          this.currentPhrase.places[replaceIndex] = card;
          this.nextReplacementIndex.places = (replaceIndex + 1) % maxPlaces;
        }
      }

      handleObjectSelection(card) {
        if (!this.currentPhrase.action || !this.currentPhrase.action.metadata) return;
        
        const metadata = this.currentPhrase.action.metadata;
        const allowedWith = metadata.allowedWith || [];
        const maxObjects = metadata.maxObjects || 0;
        
        if (!allowedWith.includes('objects')) return;
        
        if (!this.isObjectAllowed(card)) {
          return;
        }
        
        const existingIndex = this.currentPhrase.objects.findIndex(o => o.id === card.id);
        if (existingIndex !== -1) {
          this.currentPhrase.objects.splice(existingIndex, 1);
          this.updateUI();
          return;
        }
        
        if (maxObjects === 0 || this.currentPhrase.objects.length < maxObjects) {
          this.currentPhrase.objects.push(card);
        } else if (maxObjects > 0) {
          const replaceIndex = this.nextReplacementIndex.objects;
          this.currentPhrase.objects[replaceIndex] = card;
          this.nextReplacementIndex.objects = (replaceIndex + 1) % maxObjects;
        }
      }

      handleTimeSelection(card) {
        this.currentPhrase.time = card;
      }

handlePainSelection(card) {
  if (card.type === 'pain') {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ "–±–æ–ª–∏—Ç", –µ—Å–ª–∏ –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
    if (!this.currentPhrase.action || 
        (this.currentPhrase.action.id !== 'ACT-HURT' && 
         this.currentPhrase.action.id !== 'ACT-HURTS-A-LOT')) {
      this.currentPhrase.action = this.cards['ACT-HURT'];
    }
    
    this.currentPhrase.subject = '–£ –º–µ–Ω—è';
    this.currentPhrase.desire = null;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –∫ —Ç–µ–∫—É—â–µ–º—É –¥–µ–π—Å—Ç–≤–∏—é
    if (this.currentPhrase.action && this.grammar.isObjectCompatible(this.currentPhrase.action, card)) {
      // –î–ª—è –±–æ–ª–∏ - –º–∞–∫—Å–∏–º—É–º –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç
      this.currentPhrase.objects = [card];
    }
    
    this.currentPhrase.people = [];
    this.currentPhrase.pets = [];
    this.currentPhrase.places = [];
    this.currentPhrase.time = null;
    this.updateUI();
  }
}

      showWarningMessage(text) {
        const message = document.createElement('div');
        message.textContent = text;
        message.style.cssText = `
          position: fixed;
          top: 20%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(255, 152, 0, 0.9);
          color: white;
          padding: 10px 20px;
          border-radius: 5px;
          z-index: 9999;
          font-size: 16px;
          animation: fadeInOut 2s ease-in-out;
        `;

        const style = document.createElement('style');
        style.textContent = `
          @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
          }
        `;

        document.head.appendChild(style);
        document.body.appendChild(message);

        setTimeout(() => {
          if (message.parentNode) {
            document.body.removeChild(message);
          }
          if (style.parentNode) {
            document.head.removeChild(style);
          }
        }, 2000);
      }

      renderCards() {
        const container = document.getElementById('cardsContainer');
        container.innerHTML = '';

        let cardsToShow = [];
        const currentStack = this.navigationStack[this.navigationStack.length - 1];

        if (currentStack === 'ALL-ACTIONS') {
          cardsToShow = this.getAllActions();
        } else if (currentStack === 'FILTER-PEOPLE') {
          cardsToShow = this.getFilteredPeople();
        } else if (currentStack === 'FILTER-PLACES') {
          cardsToShow = this.getFilteredPlaces();
        } else if (currentStack === 'FILTER-OBJECTS') {
          cardsToShow = this.getFilteredObjects();
        } else if (currentStack === 'FILTER-TIME') {
          cardsToShow = this.getFilteredTime();
        } else if (this.navigationStack.length > 0 && currentStack.startsWith('CAT-')) {
          const currentCategoryId = currentStack;
          
          if (currentCategoryId === 'CAT-ALL') {
            cardsToShow = Object.values(this.cards).filter(card =>
              card.type !== 'category' && card.sections.includes('–ì–ª–∞–≤–Ω–∞—è')
            );
          } else {
            cardsToShow = Object.values(this.cards).filter(card =>
              card.category === currentCategoryId && card.sections.includes('–ì–ª–∞–≤–Ω–∞—è')
            );
          }
        }

        if (cardsToShow.length === 0) {
          container.innerHTML = '<div class="no-action-message">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</div>';
          return;
        }

        this.renderCardList(container, cardsToShow, 'main');
      }

      getAllActions() {
        return Object.values(this.cards).filter(card =>
          (card.type === 'action' || card.type === 'emotion' || 
           card.type === 'learning' || card.type === 'help' || 
           card.type === 'request' || card.type === 'dialog') &&
          card.sections.includes('–ì–ª–∞–≤–Ω–∞—è')
        );
      }

      renderCardList(container, cardsToShow, tabId = 'main') {
        cardsToShow.sort((a, b) => {
          const typeOrder = {
            'action': 1, 'emotion': 1, 'learning': 1, 'help': 1, 'request': 1, 'dialog': 1,
            'person': 2, 'pet': 3, 'place': 4, 'object': 5, 'clothing': 6,
            'book': 7, 'creative': 8, 'pain': 9, 'time': 10
          };
          return (typeOrder[a.type] || 10) - (typeOrder[b.type] || 10);
        });

        cardsToShow.forEach(card => {
          const cardElement = document.createElement('div');
          cardElement.className = `card ${card.type}`;
          
          if (card.color) {
            cardElement.style.backgroundColor = card.color;
            cardElement.style.borderColor = card.borderColor || card.color;
          }
          
          const isSelected = (this.currentPhrase.action && card.id === this.currentPhrase.action.id) ||
            this.currentPhrase.people.some(p => p.id === card.id) ||
            this.currentPhrase.pets.some(p => p.id === card.id) ||
            this.currentPhrase.places.some(p => p.id === card.id) ||
            this.currentPhrase.objects.some(o => o.id === card.id) ||
            (this.currentPhrase.time && card.id === this.currentPhrase.time.id);

          if (isSelected) {
            cardElement.classList.add('selected');
            cardElement.style.borderColor = '#ffc107';
          }

          let isDisabled = false;
          let disabledReason = '';

          if (this.currentPhrase.action && this.currentPhrase.action.metadata) {
            const metadata = this.currentPhrase.action.metadata;
            const allowedWith = metadata.allowedWith || [];

            if (card.type === 'person' && !allowedWith.includes('people')) {
              isDisabled = true;
              disabledReason = '–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –ª—é–¥–µ–π –∫ —ç—Ç–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é';
            }

            if (card.type === 'pet' && !allowedWith.includes('pets')) {
              isDisabled = true;
              disabledReason = '–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –ø–∏—Ç–æ–º—Ü–µ–≤ –∫ —ç—Ç–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é';
            }

            if (card.type === 'place' && !allowedWith.includes('places')) {
              isDisabled = true;
              disabledReason = '–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–∞ –∫ —ç—Ç–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é';
            }

            if ((card.type === 'object' || card.type === 'clothing' || card.type === 'book' || card.type === 'creative' || card.type === 'pain') && !allowedWith.includes('objects')) {
              isDisabled = true;
              disabledReason = '–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç—ã –∫ —ç—Ç–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é';
            }

            if ((card.type === 'object' || card.type === 'clothing' || card.type === 'book' || card.type === 'creative') && allowedWith.includes('objects')) {
              const allowedObjects = metadata.allowedObjects || [];
              if (allowedObjects.length > 0 && !allowedObjects.includes(card.id)) {
                isDisabled = true;
                disabledReason = '–≠—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è';
              }
            }
          }

          if (isDisabled && !isSelected) {
            cardElement.classList.add('disabled');
            cardElement.title = disabledReason;
          }

          cardElement.innerHTML = `
            <div class="card-emoji">${card.emoji}</div>
            <div class="card-text">${card.text}</div>
          `;

          if (!isDisabled || isSelected) {
            cardElement.addEventListener('click', () => {
              this.selectCard(card.id, tabId);
            });
          }

          container.appendChild(cardElement);
        });
      }

      getFilteredPeople() {
        return Object.values(this.cards).filter(card =>
          card.type === 'person' && card.sections.includes('–ì–ª–∞–≤–Ω–∞—è')
        );
      }

      getFilteredPlaces() {
        return Object.values(this.cards).filter(card =>
          card.type === 'place' && card.sections.includes('–ì–ª–∞–≤–Ω–∞—è')
        );
      }

      getFilteredObjects() {
        if (!this.currentPhrase.action || !this.currentPhrase.action.metadata) {
          return [];
        }

        const metadata = this.currentPhrase.action.metadata;
        const allowedObjects = metadata.allowedObjects || [];
        
        if (allowedObjects.length === 0) {
          const actionCategory = this.currentPhrase.action.category;
          return Object.values(this.cards).filter(card =>
            (card.type === 'object' || card.type === 'clothing' || card.type === 'book' || card.type === 'creative') &&
            card.category === actionCategory &&
            card.sections.includes('–ì–ª–∞–≤–Ω–∞—è')
          );
        } else {
          return Object.values(this.cards).filter(card =>
            allowedObjects.includes(card.id) &&
            card.sections.includes('–ì–ª–∞–≤–Ω–∞—è')
          );
        }
      }

      getFilteredTime() {
        return Object.values(this.cards).filter(card =>
          card.type === 'time' && card.sections.includes('–ì–ª–∞–≤–Ω–∞—è')
        );
      }

      updateQuickNavigation() {
        const quickNav = document.getElementById('quickNavigation');
        const peopleBtn = document.getElementById('quickPeopleBtn');
        const placesBtn = document.getElementById('quickPlacesBtn');
        const objectsBtn = document.getElementById('quickObjectsBtn');
        const timeBtn = document.getElementById('quickTimeBtn');

        const showQuickNav = this.currentPhrase.action &&
          this.currentPhrase.action.type !== 'emotion' &&
          this.currentPhrase.action.id !== 'ACT-HURT' &&
          !(this.currentPhrase.action.metadata && this.currentPhrase.action.metadata.isStandalone);

        if (showQuickNav) {
          quickNav.style.display = 'flex';
          
          const metadata = this.currentPhrase.action?.metadata || {};
          const allowedWith = metadata.allowedWith || [];
          
          const canAddPeople = allowedWith.includes('people');
          peopleBtn.disabled = !canAddPeople;
          
          const canAddPlaces = allowedWith.includes('places');
          placesBtn.disabled = !canAddPlaces;
          
          const canAddObjects = allowedWith.includes('objects');
          objectsBtn.disabled = !canAddObjects;
          
          timeBtn.disabled = false;
        } else {
          quickNav.style.display = 'none';
        }
      }

      setSubject(subject) {
        this.currentPhrase.subject = subject;
        this.updateUI();
      }

      setDesire(desire) {
        this.currentPhrase.desire = desire;
        this.updateUI();
      }

      selectCategory(categoryId) {
        this.filterMode = null;
        this.isQuickNavMode = false;
        this.navigationStack.push(categoryId);
        this.renderCards();
        this.toggleBackButton();
        this.showCardsView();
        this.updateQuickNavigation();
        this.hideDoneButton();
      }

      selectCard(cardId, tabId = 'main') {
        const card = this.cards[cardId];
        if (!card) return;

        if (tabId === 'learning' || tabId === 'dialog' || tabId === 'emotions') {
          this.speakText(card.text);
          return;
        }

        if (this.navigationStack.includes('CAT-PAIN')) {
          this.handlePainSelection(card);
          this.updateUI();
          return;
        }

        if (this.cardTypeHandlers[card.type]) {
          this.cardTypeHandlers[card.type](card);
        } else {
          this.currentPhrase.objects.push(card);
        }

        this.updateUI();
        
        if (this.filterMode && !this.isQuickNavMode) {
          this.navigateBack();
        }
      }

isObjectAllowed(card) {
  if (!this.currentPhrase.action) return true;
   return this.grammar.isObjectCompatible(this.currentPhrase.action, card);
}

      checkAndResetIncompatibleElements(oldAction, newAction) {
        if (!oldAction || !newAction) return;
        
        const newMetadata = newAction.metadata || {};
        const newAllowedObjects = newMetadata.allowedObjects || [];
        
        if (newAllowedObjects.length > 0) {
          this.currentPhrase.objects = this.currentPhrase.objects.filter(obj => 
            newAllowedObjects.includes(obj.id)
          );
        } else if (newAction.category !== oldAction.category) {
          this.currentPhrase.objects = [];
        }
      }

      removeElement(type, id) {
        switch(type) {
          case 'subject': this.currentPhrase.subject = null; break;
          case 'desire': this.currentPhrase.desire = null; break;
          case 'action': this.currentPhrase.action = null; break;
          case 'person': 
            this.currentPhrase.people = this.currentPhrase.people.filter(p => p.id !== id);
            this.nextReplacementIndex.people = 0;
            break;
          case 'pet': this.currentPhrase.pets = this.currentPhrase.pets.filter(p => p.id !== id); break;
          case 'place': 
            this.currentPhrase.places = this.currentPhrase.places.filter(p => p.id !== id);
            this.nextReplacementIndex.places = 0;
            break;
          case 'object': 
            this.currentPhrase.objects = this.currentPhrase.objects.filter(o => o.id !== id);
            this.nextReplacementIndex.objects = 0;
            break;
          case 'time': this.currentPhrase.time = null; break;
        }
        this.updateUI();
      }

      navigateBack() {
        if (this.navigationStack.length > 1) {
          this.navigationStack.pop();
          this.renderCards();
        } else {
          this.navigateToHome();
        }
        this.filterMode = null;
        this.isQuickNavMode = false;
        this.toggleBackButton();
        this.updateQuickNavigation();
        this.hideDoneButton();
      }

      navigateBackTab(tabId) {
        const stack = this.tabNavigationStacks[tabId];
        if (stack.length > 1) {
          stack.pop();
          this.renderTabCards(tabId, stack[stack.length - 1]);
        } else {
          this.navigateToHomeTab(tabId);
        }
      }

      navigateToHome() {
        this.navigationStack = [];
        this.filterMode = null;
        this.isQuickNavMode = false;
        this.renderCategories();
        this.toggleBackButton();
        this.showCategoriesView();
        this.updateQuickNavigation();
        this.hideDoneButton();
      }

      navigateToHomeTab(tabId) {
        this.tabNavigationStacks[tabId] = [];
        this.tabCurrentViews[tabId] = 'categories';
        this.renderTabCategories(tabId);
      }

      showCategoriesView() {
        document.getElementById('categoriesView').style.display = 'block';
        document.getElementById('cardsView').style.display = 'none';
        this.currentView = 'categories';
      }

      showCardsView() {
        document.getElementById('categoriesView').style.display = 'none';
        document.getElementById('cardsView').style.display = 'block';
        this.currentView = 'cards';
      }

      toggleBackButton() {
        const backBtn = document.getElementById('backBtn');
        backBtn.style.display = this.navigationStack.length > 0 ? 'block' : 'none';
      }

      clearPhrase() {
        this.currentPhrase = {
          subject: null,
          desire: null,
          action: null,
          people: [],
          pets: [],
          places: [],
          objects: [],
          time: null
        };
        this.nextReplacementIndex = {
          people: 0,
          places: 0,
          objects: 0
        };
        this.updateUI();
      }

      updatePhraseDisplay() {
        const phraseDisplay = document.getElementById('phraseDisplay');
        const phrase = this.grammar.buildPhrase(this.currentPhrase);
        phraseDisplay.textContent = phrase || '–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ñ—Ä–∞–∑—ã';
      }

      speakPhrase() {
        const phrase = document.getElementById('phraseDisplay').textContent;
        if (phrase && phrase !== '–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ñ—Ä–∞–∑—ã') {
          this.speakText(phrase);
        }
      }

      updateUI() {
        this.updatePhraseDisplay();
        this.updateSelectedItems();
        this.updateRulesInfo();
        this.renderCards();
        this.updateQuickNavigation();
      }

      updateSelectedItems() {
        const container = document.getElementById('selectedItems');
        container.innerHTML = '';

        if (this.currentPhrase.subject) {
          this.addSelectedItem(container, 'subject', null, this.currentPhrase.subject);
        }

        if (this.currentPhrase.desire) {
          this.addSelectedItem(container, 'desire', null, this.currentPhrase.desire);
        }

        if (this.currentPhrase.action) {
          this.addSelectedItem(container, 'action', this.currentPhrase.action.id, this.currentPhrase.action.text, this.currentPhrase.action.emoji);
        }

        this.currentPhrase.people.forEach((person, index) => {
          this.addSelectedItem(container, 'person', person.id, person.text, person.emoji, true, index);
        });

        this.currentPhrase.pets.forEach(pet => {
          this.addSelectedItem(container, 'pet', pet.id, pet.text, pet.emoji, true);
        });

        this.currentPhrase.places.forEach((place, index) => {
          this.addSelectedItem(container, 'place', place.id, place.text, place.emoji, true, index);
        });

        this.currentPhrase.objects.forEach((object, index) => {
          this.addSelectedItem(container, 'object', object.id, object.text, object.emoji, true, index);
        });

        if (this.currentPhrase.time) {
          this.addSelectedItem(container, 'time', this.currentPhrase.time.id, this.currentPhrase.time.text, this.currentPhrase.time.emoji, true);
        }
      }

      addSelectedItem(container, type, id, text, emoji = null, canReplace = false, index = -1) {
        const item = document.createElement('div');
        item.className = 'selected-item';
        if (canReplace) {
          item.classList.add('can-replace');
        }

        item.innerHTML = `
          ${emoji ? emoji + ' ' : ''}${text}
          <span class="remove" data-type="${type}" data-id="${id || ''}">√ó</span>
        `;

        const removeBtn = item.querySelector('.remove');
        removeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.removeElement(type, id);
        });

        if (canReplace) {
          item.addEventListener('click', (e) => {
            if (e.target !== removeBtn) {
              this.showReplacementCategory(type, index);
            }
          });
        }

        container.appendChild(item);
      }

      showReplacementCategory(type, index) {
        let categoryId = '';
        switch(type) {
          case 'person':
            categoryId = 'CAT-PEOPLE';
            break;
          case 'pet':
            categoryId = 'CAT-PETS';
            break;
          case 'place':
            categoryId = 'CAT-PLACES';
            break;
          case 'object':
            if (this.currentPhrase.action) {
              const category = this.currentPhrase.action.category;
              if (category) {
                categoryId = category;
              }
            }
            break;
          case 'time':
            categoryId = 'CAT-TIME';
            break;
        }

        if (categoryId) {
          this.currentReplacement = { type, index };
          this.selectCategory(categoryId);
        }
      }

      updateRulesInfo() {
        const rulesElement = document.getElementById('rulesInfo');
        let rulesText = '';

		  if (this.currentPhrase.action && 
      (this.currentPhrase.action.id === 'ACT-HURT' || 
       this.currentPhrase.action.id === 'ACT-HURTS-A-LOT')) {
    rulesText = '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—Ç—å —Ç–µ–ª–∞, –∫–æ—Ç–æ—Ä–∞—è –±–æ–ª–∏—Ç. –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É —á–∞—Å—Ç—å —Ç–µ–ª–∞.';
  }
  else if (this.currentPhrase.action && this.currentPhrase.action.type === 'emotion') {
    rulesText = '–≠–º–æ—Ü–∏–∏ –≤—ã—Ä–∞–∂–∞—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ—Ü–∏—é –¥–ª—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.';
  }
  else if (this.navigationStack.includes('CAT-PAIN')) {
    rulesText = '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—Ç—å —Ç–µ–ª–∞, –∫–æ—Ç–æ—Ä–∞—è –±–æ–ª–∏—Ç.';
  }
		
        if (this.currentPhrase.action && this.currentPhrase.action.type === 'emotion') {
          rulesText = '–≠–º–æ—Ü–∏–∏ –≤—ã—Ä–∞–∂–∞—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ—Ü–∏—é –¥–ª—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.';
        } else if (this.navigationStack.includes('CAT-PAIN')) {
          rulesText = '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—Ç—å —Ç–µ–ª–∞, –∫–æ—Ç–æ—Ä–∞—è –±–æ–ª–∏—Ç.';
        } else if (this.currentPhrase.action && this.currentPhrase.action.metadata && this.currentPhrase.action.metadata.isStandalone) {
          rulesText = '–≠—Ç–æ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ñ—Ä–∞–∑–∞, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è.';
        } else if (this.currentPhrase.action) {
          const metadata = this.currentPhrase.action.metadata || {};
          const allowedWith = metadata.allowedWith || [];
          const maxPeople = metadata.maxPeople || 0;
          const maxPets = metadata.maxPets || 0;
          const maxPlaces = metadata.maxPlaces || 0;
          const maxObjects = metadata.maxObjects || 0;

          rulesText = `–ö –¥–µ–π—Å—Ç–≤–∏—é "${this.currentPhrase.action.text}" –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å: `;
          const availableElements = [];
          const limitElements = [];

          if (allowedWith.includes('people')) {
            const currentPeople = this.currentPhrase.people.length;
            if (maxPeople === 0) {
              availableElements.push('–ª—é–¥–µ–π (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)');
            } else if (currentPeople < maxPeople) {
              availableElements.push(`–¥–æ ${maxPeople} ${this.getPeopleWord(maxPeople)}`);
            } else {
              limitElements.push(`${maxPeople} ${this.getPeopleWord(maxPeople)} (–¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç, —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–º–µ–Ω–∏—Ç –ø–æ –æ—á–µ—Ä–µ–¥–∏)`);
            }
          }

          if (allowedWith.includes('places')) {
            const currentPlaces = this.currentPhrase.places.length;
            if (maxPlaces === 0) {
              availableElements.push('–º–µ—Å—Ç (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)');
            } else if (currentPlaces < maxPlaces) {
              availableElements.push(`–¥–æ ${maxPlaces} ${this.getPlacesWord(maxPlaces)}`);
            } else {
              limitElements.push(`${maxPlaces} ${this.getPlacesWord(maxPlaces)} (–¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç, —Å–ª–µ–¥—É—é—â–µ–µ –∑–∞–º–µ–Ω–∏—Ç –ø–æ –æ—á–µ—Ä–µ–¥–∏)`);
            }
          }

          if (allowedWith.includes('objects')) {
            const currentObjects = this.currentPhrase.objects.length;
            if (maxObjects === 0) {
              availableElements.push('–æ–±—ä–µ–∫—Ç–æ–≤ (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)');
            } else if (currentObjects < maxObjects) {
              availableElements.push(`–¥–æ ${maxObjects} ${this.getObjectsWord(maxObjects)}`);
            } else {
              limitElements.push(`${maxObjects} ${this.getObjectsWord(maxObjects)} (–¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç, —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–º–µ–Ω–∏—Ç –ø–æ –æ—á–µ—Ä–µ–¥–∏)`);
            }
          }

          if (allowedWith.includes('pets')) {
            const currentPets = this.currentPhrase.pets.length;
            if (maxPets === 0) {
              availableElements.push('–ø–∏—Ç–æ–º—Ü–µ–≤ (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)');
            } else if (currentPets < maxPets) {
              availableElements.push(`–¥–æ ${maxPets} ${this.getPetsWord(maxPets)}`);
            } else {
              limitElements.push(`${maxPets} ${this.getPetsWord(maxPets)} (–¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç, —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–º–µ–Ω–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ)`);
            }
          }

          let mainText = '';
          if (availableElements.length > 0) {
            mainText = availableElements.join(', ');
            if (limitElements.length > 0) {
              mainText += `, ${limitElements.join(', ')}`;
            }
          } else if (limitElements.length > 0) {
            mainText = limitElements.join(', ');
          }

          if (mainText) {
            rulesText += mainText;
            if (!this.currentPhrase.time) {
              rulesText += ' –∏ –≤—Ä–µ–º—è (–≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–º–µ–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–µ)';
            } else {
              rulesText += '. –í—Ä–µ–º—è –≤—ã–±—Ä–∞–Ω–æ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å).';
            }
          } else {
            rulesText += '–Ω–∏—á–µ–≥–æ –Ω–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å';
            if (!this.currentPhrase.time) {
              rulesText += ', –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è (–≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–º–µ–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–µ)';
            } else {
              rulesText += '. –í—Ä–µ–º—è –≤—ã–±—Ä–∞–Ω–æ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å).';
            }
          }
        } else {
          rulesText = '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ñ—Ä–∞–∑—ã.';
        }

        rulesElement.textContent = rulesText;
      }

      getPeopleWord(count) {
        if (count === 1) return '—á–µ–ª–æ–≤–µ–∫–∞';
        return '–ª—é–¥–µ–π';
      }

      getPetsWord(count) {
        if (count === 1) return '–ø–∏—Ç–æ–º—Ü–∞';
        return '–ø–∏—Ç–æ–º—Ü–µ–≤';
      }

      getPlacesWord(count) {
        if (count === 1) return '–º–µ—Å—Ç–∞';
        return '–º–µ—Å—Ç';
      }

      getObjectsWord(count) {
        if (count === 1) return '–æ–±—ä–µ–∫—Ç–∞';
        return '–æ–±—ä–µ–∫—Ç–æ–≤';
      }

      renderCategories() {
        const container = document.getElementById('categoriesContainer');
        container.innerHTML = '';

        const categories = Object.values(this.cards).filter(card =>
          card.type === 'category' &&
          card.category === null &&
          card.sections.includes('–ì–ª–∞–≤–Ω–∞—è')
        );

        categories.sort((a, b) => {
          const aOrder = a.order || 50;
          const bOrder = b.order || 50;
          if (aOrder !== bOrder) {
            return aOrder - bOrder;
          }
          return a.text.localeCompare(b.text);
        });

        categories.forEach(category => {
          const categoryElement = document.createElement('div');
          categoryElement.className = 'category-card';
          
          if (category.color) {
            categoryElement.style.backgroundColor = category.color;
            categoryElement.style.borderColor = category.borderColor || category.color;
          }
          
          categoryElement.innerHTML = `
            <div class="card-emoji">${category.emoji}</div>
            <div class="card-text">${category.text}</div>
          `;

          categoryElement.addEventListener('click', () => {
            this.selectCategory(category.id);
          });

          container.appendChild(categoryElement);
        });
      }

      renderLearningTab() {
        this.renderTabCategories('learning');
      }

      renderDialogTab() {
        this.renderTabCategories('dialog');
      }

      renderEmotionsTab() {
        this.renderTabCategories('emotions');
      }

      renderTabCategories(tabId) {
        const sectionsMap = {
          'emotions': '–≠–º–æ—Ü–∏–∏',
          'learning': '–û–±—É—á–µ–Ω–∏–µ',
          'dialog': '–î–∏–∞–ª–æ–≥'
        };

        const sectionName = sectionsMap[tabId];
        const categoriesContainerId = `${tabId}CategoriesContainer`;
        const categoriesViewId = `${tabId}CategoriesView`;
        const cardsViewId = `${tabId}CardsView`;
        const cardsContainerId = `${tabId}CardsContainer`;
        const backBtnId = `backBtn${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`;

        document.getElementById(categoriesViewId).style.display = 'block';
        document.getElementById(cardsViewId).style.display = 'none';
        document.getElementById(backBtnId).style.display = 'none';

        const container = document.getElementById(categoriesContainerId);
        container.innerHTML = '';

        const categories = Object.values(this.cards).filter(card =>
          card.type === 'category' &&
          card.category === null &&
          card.sections.includes(sectionName)
        );

        if (categories.length === 0) {
          this.renderTabAllCards(tabId);
          return;
        }

        categories.sort((a, b) => {
          const aOrder = a.order || 50;
          const bOrder = b.order || 50;
          if (aOrder !== bOrder) {
            return aOrder - bOrder;
          }
          return a.text.localeCompare(b.text);
        });

        categories.forEach(category => {
          const categoryElement = document.createElement('div');
          categoryElement.className = 'category-card';
          
          if (category.color) {
            categoryElement.style.backgroundColor = category.color;
            categoryElement.style.borderColor = category.borderColor || category.color;
          }
          
          categoryElement.innerHTML = `
            <div class="card-emoji">${category.emoji}</div>
            <div class="card-text">${category.text}</div>
          `;

          categoryElement.addEventListener('click', () => {
            this.tabNavigationStacks[tabId].push(category.id);
            this.tabCurrentViews[tabId] = 'cards';
            this.renderTabCards(tabId, category.id);
          });

          container.appendChild(categoryElement);
        });
      }

      renderTabCards(tabId, categoryId) {
        const sectionsMap = {
          'emotions': '–≠–º–æ—Ü–∏–∏',
          'learning': '–û–±—É—á–µ–Ω–∏–µ',
          'dialog': '–î–∏–∞–ª–æ–≥'
        };

        const sectionName = sectionsMap[tabId];
        const categoriesViewId = `${tabId}CategoriesView`;
        const cardsViewId = `${tabId}CardsView`;
        const cardsContainerId = `${tabId}CardsContainer`;
        const backBtnId = `backBtn${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`;

        document.getElementById(categoriesViewId).style.display = 'none';
        document.getElementById(cardsViewId).style.display = 'block';
        document.getElementById(backBtnId).style.display = 'block';

        const container = document.getElementById(cardsContainerId);
        container.innerHTML = '';

        let cardsToShow = [];
        
        if (categoryId === 'ALL') {
          cardsToShow = Object.values(this.cards).filter(card =>
            card.type !== 'category' && card.sections.includes(sectionName)
          );
        } else {
          cardsToShow = Object.values(this.cards).filter(card =>
            card.category === categoryId && card.sections.includes(sectionName)
          );
        }

        if (cardsToShow.length === 0) {
          container.innerHTML = '<div class="no-action-message">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</div>';
          return;
        }

        cardsToShow.sort((a, b) => a.text.localeCompare(b.text));
        
        cardsToShow.forEach(card => {
          const cardElement = document.createElement('div');
          cardElement.className = `card ${card.type}`;
          
          if (card.color) {
            cardElement.style.backgroundColor = card.color;
            cardElement.style.borderColor = card.borderColor || card.color;
          }
          
          cardElement.innerHTML = `
            <div class="card-emoji">${card.emoji}</div>
            <div class="card-text">${card.text}</div>
          `;

          cardElement.addEventListener('click', () => {
            this.selectCard(card.id, tabId);
          });

          container.appendChild(cardElement);
        });
      }

      renderTabAllCards(tabId) {
        const sectionsMap = {
          'emotions': '–≠–º–æ—Ü–∏–∏',
          'learning': '–û–±—É—á–µ–Ω–∏–µ',
          'dialog': '–î–∏–∞–ª–æ–≥'
        };

        const sectionName = sectionsMap[tabId];
        const categoriesViewId = `${tabId}CategoriesView`;
        const cardsViewId = `${tabId}CardsView`;
        const cardsContainerId = `${tabId}CardsContainer`;
        const backBtnId = `backBtn${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`;

        document.getElementById(categoriesViewId).style.display = 'none';
        document.getElementById(cardsViewId).style.display = 'block';
        document.getElementById(backBtnId).style.display = 'none';

        const container = document.getElementById(cardsContainerId);
        container.innerHTML = '';

        const cardsToShow = Object.values(this.cards).filter(card =>
          card.type !== 'category' && card.sections.includes(sectionName)
        );

        if (cardsToShow.length === 0) {
          container.innerHTML = '<div class="no-action-message">–í —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</div>';
          return;
        }

        cardsToShow.sort((a, b) => a.text.localeCompare(b.text));
        
        cardsToShow.forEach(card => {
          const cardElement = document.createElement('div');
          cardElement.className = `card ${card.type}`;
          
          if (card.color) {
            cardElement.style.backgroundColor = card.color;
            cardElement.style.borderColor = card.borderColor || card.color;
          }
          
          cardElement.innerHTML = `
            <div class="card-emoji">${card.emoji}</div>
            <div class="card-text">${card.text}</div>
          `;

          cardElement.addEventListener('click', () => {
            this.selectCard(card.id, tabId);
          });

          container.appendChild(cardElement);
        });
      }

      handleEmergency(type) {
        const messages = {
          'help': 'üÜò –ü–û–ú–û–ì–ò–¢–ï! –ú–Ω–µ —Å—Ä–æ—á–Ω–æ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å!',
          'pain': 'ü§ï –£ –º–µ–Ω—è –°–ò–õ–¨–ù–ê–Ø –ë–û–õ–¨! –ù—É–∂–µ–Ω –≤—Ä–∞—á!',
          'scared': 'üò® –ú–Ω–µ –û–ß–ï–ù–¨ –°–¢–†–ê–®–ù–û! –ü–æ–º–æ–≥–∏—Ç–µ!',
          'sick': 'ü§¢ –ú–µ–Ω—è –¢–û–®–ù–ò–¢! –ü–ª–æ—Ö–æ!',
          'lost': this.getLostMessage(),
          'call': 'üìû –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –º–æ–∏–º —Ä–æ–¥–∏—Ç–µ–ª—è–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞!',
          'stop': 'üõë –°–¢–û–ü! –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å!'
        };

        const message = messages[type] || '–¢—Ä–µ–≤–æ–≥–∞!';
        this.speakEmergency(message);

        if (type === 'call') {
          setTimeout(() => {
            this.callParents();
          }, 1000);
        } else {
          this.showEmergencyAlert(message);
        }
      }

      getLostMessage() {
        const address = this.childInfo.address || '–∞–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
        return `üó∫Ô∏è –Ø –∑–∞–±–ª—É–¥–∏–ª—Å—è! –ú–æ–π –∞–¥—Ä–µ—Å: ${address}. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–º–æ–≥–∏—Ç–µ –º–Ω–µ!`;
      }

      callParents() {
        const motherPhone = this.childInfo.motherPhone;
        const fatherPhone = this.childInfo.fatherPhone;
        let message = "–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –º–æ–∏–º —Ä–æ–¥–∏—Ç–µ–ª—è–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞!\n\n";
        
        if (motherPhone && fatherPhone) {
          message += `–¢–µ–ª–µ—Ñ–æ–Ω –º–∞–º—ã: ${motherPhone}\n–¢–µ–ª–µ—Ñ–æ–Ω –ø–∞–ø—ã: ${fatherPhone}`;
        } else if (motherPhone) {
          message += `–¢–µ–ª–µ—Ñ–æ–Ω –º–∞–º—ã: ${motherPhone}`;
        } else if (fatherPhone) {
          message += `–¢–µ–ª–µ—Ñ–æ–Ω –ø–∞–ø—ã: ${fatherPhone}`;
        } else {
          message += "–¢–µ–ª–µ—Ñ–æ–Ω—ã —Ä–æ–¥–∏—Ç–µ–ª–µ–π –Ω–µ —É–∫–∞–∑–∞–Ω—ã –≤ —Ä–∞–∑–¥–µ–ª–µ '–î–∞–Ω–Ω—ã–µ –æ —Ä–µ–±–µ–Ω–∫–µ'";
        }
        
        this.showEmergencyAlertWithPhones(message);
        
        if (motherPhone || fatherPhone) {
          console.log(`–í—ã–∑–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª–µ–π... –ú–∞–º–∞: ${motherPhone}, –ü–∞–ø–∞: ${fatherPhone}`);
        }
      }

      speakEmergency(message) {
        if ('speechSynthesis' in window) {
          speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(message);
          utterance.lang = 'ru-RU';
          utterance.rate = 1.2;
          utterance.pitch = 1.3;
          utterance.volume = 1.0;
          speechSynthesis.speak(utterance);
        }
      }

      showEmergencyAlert(message) {
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(231, 76, 60, 0.95);
          color: white;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          font-size: 2rem;
          text-align: center;
          padding: 20px;
          animation: pulse 1s infinite;
        `;
        
        const style = document.createElement('style');
        style.textContent = `
          @keyframes pulse {
            0% { background-color: rgba(231, 76, 60, 0.95); }
            50% { background-color: rgba(192, 57, 43, 0.95); }
            100% { background-color: rgba(231, 76, 60, 0.95); }
          }
        `;
        
        alertDiv.innerHTML = `
          <div style="font-size: 4rem; margin-bottom: 20px;">‚ö†Ô∏è</div>
          <div style="font-weight: bold; margin-bottom: 20px;">${message}</div>
          <div style="font-size: 1.5rem; margin-bottom: 30px;">–ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å!</div>
          <button id="closeEmergency" style="
            background: white;
            color: #e74c3c;
            border: none;
            padding: 15px 30px;
            font-size: 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
          ">–ó–∞–∫—Ä—ã—Ç—å</button>
        `;
        
        document.body.appendChild(style);
        document.body.appendChild(alertDiv);
        
        document.getElementById('closeEmergency').addEventListener('click', () => {
          document.body.removeChild(alertDiv);
          document.head.removeChild(style);
          speechSynthesis.cancel();
        });
        
        setTimeout(() => {
          if (document.body.contains(alertDiv)) {
            document.body.removeChild(alertDiv);
            document.head.removeChild(style);
          }
        }, 30000);
      }

      showEmergencyAlertWithPhones(message) {
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(52, 152, 219, 0.95);
          color: white;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          font-size: 1.5rem;
          text-align: center;
          padding: 20px;
        `;
        
        alertDiv.innerHTML = `
          <div style="font-size: 4rem; margin-bottom: 20px;">üìû</div>
          <div style="font-weight: bold; margin-bottom: 20px;">–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –º–æ–∏–º —Ä–æ–¥–∏—Ç–µ–ª—è–º!</div>
          <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: left; font-size: 1.2rem;">
            ${message.split('\n').map(line => `<div style="margin-bottom: 10px;">${line}</div>`).join('')}
          </div>
          <button id="closeEmergency" style="
            background: white;
            color: #3498db;
            border: none;
            padding: 15px 30px;
            font-size: 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
          ">–ó–∞–∫—Ä—ã—Ç—å</button>
        `;
        
        document.body.appendChild(alertDiv);
        
        document.getElementById('closeEmergency').addEventListener('click', () => {
          document.body.removeChild(alertDiv);
          speechSynthesis.cancel();
        });
        
        setTimeout(() => {
          if (document.body.contains(alertDiv)) {
            document.body.removeChild(alertDiv);
          }
        }, 30000);
      }

      renderChildInfo(editable = false) {
        const container = document.getElementById('childInfoGrid');
        const info = this.childInfo;

        container.innerHTML = `
          <div class="child-card">
            <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="form-group">
              <label>–ò–º—è —Ä–µ–±–µ–Ω–∫–∞</label>
              <input type="text" id="childName" value="${info.name || ''}" 
                     placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" ${editable ? '' : 'disabled class="view-only"'}>
            </div>
            <div class="form-group">
              <label>–í–æ–∑—Ä–∞—Å—Ç</label>
              <input type="number" id="childAge" value="${info.age || ''}" 
                     placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç" ${editable ? '' : 'disabled class="view-only"'}>
            </div>
            <div class="form-group">
              <label>–ü–æ–ª</label>
              <select id="childGender" ${editable ? '' : 'disabled class="view-only"'}>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                <option value="male" ${info.gender === 'male' ? 'selected' : ''}>–ú–∞–ª—å—á–∏–∫</option>
                <option value="female" ${info.gender === 'female' ? 'selected' : ''}>–î–µ–≤–æ—á–∫–∞</option>
              </select>
            </div>
            <div class="form-group">
              <label>–ê–¥—Ä–µ—Å</label>
              <input type="text" id="childAddress" value="${info.address || ''}" 
                     placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å" ${editable ? '' : 'disabled class="view-only"'}>
            </div>
            ${editable ? '<button class="save-btn" onclick="window.communicator.saveChildInfo()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>' : ''}
          </div>

          <div class="child-card">
            <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
            <div class="form-group">
              <label>–¢–µ–ª–µ—Ñ–æ–Ω –º–∞–º—ã</label>
              <input type="tel" id="motherPhone" value="${info.motherPhone || ''}" 
                     placeholder="+7 (___) ___-__-__" ${editable ? '' : 'disabled class="view-only"'}>
            </div>
            <div class="form-group">
              <label>–¢–µ–ª–µ—Ñ–æ–Ω –ø–∞–ø—ã</label>
              <input type="tel" id="fatherPhone" value="${info.fatherPhone || ''}" 
                     placeholder="+7 (___) ___-__-__" ${editable ? '' : 'disabled class="view-only"'}>
            </div>
            <div class="form-group">
              <label>–¢–µ–ª–µ—Ñ–æ–Ω –≤—Ä–∞—á–∞</label>
              <input type="tel" id="doctorPhone" value="${info.doctorPhone || ''}" 
                     placeholder="+7 (___) ___-__-__" ${editable ? '' : 'disabled class="view-only"'}>
            </div>
            ${editable ? '<button class="save-btn" onclick="window.communicator.saveContacts()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>' : ''}
          </div>

          <div class="child-card">
            <h3>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="form-group">
              <label>–î–∏–∞–≥–Ω–æ–∑</label>
              <textarea id="childDiagnosis" ${editable ? '' : 'disabled class="view-only"'}>${info.diagnosis || ''}</textarea>
            </div>
            <div class="form-group">
              <label>–ê–ª–ª–µ—Ä–≥–∏–∏</label>
              <textarea id="childAllergies" ${editable ? '' : 'disabled class="view-only"'}>${info.allergies || ''}</textarea>
            </div>
            ${editable ? '<button class="save-btn" onclick="window.communicator.saveMedicalInfo()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>' : ''}
          </div>

          <div class="child-card">
            <h3>–ù–∞–≤—ã–∫–∏ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è</h3>
            <div class="form-group">
              <label>–õ—é–±–∏–º—ã–µ –∑–∞–Ω—è—Ç–∏—è</label>
              <textarea id="childInterests" ${editable ? '' : 'disabled class="view-only"'}>${info.interests || ''}</textarea>
            </div>
            <div class="form-group">
              <label>–ù–µ –ª—é–±–∏—Ç/–ë–æ–∏—Ç—Å—è</label>
              <textarea id="childDislikes" ${editable ? '' : 'disabled class="view-only"'}>${info.dislikes || ''}</textarea>
            </div>
            ${editable ? '<button class="save-btn" onclick="window.communicator.saveSkillsInfo()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>' : ''}
          </div>
        `;
      }

      enableChildEditing() {
        this.renderChildInfo(true);
        document.getElementById('editChildBtn').style.display = 'none';
      }

      saveChildInfo() {
        this.childInfo.name = document.getElementById('childName').value;
        this.childInfo.age = document.getElementById('childAge').value;
        this.childInfo.gender = document.getElementById('childGender').value;
        this.childInfo.address = document.getElementById('childAddress').value;
        localStorage.setItem('childInfo', JSON.stringify(this.childInfo));
        alert('–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        this.renderChildInfo(false);
        document.getElementById('editChildBtn').style.display = 'block';
        isEditingEnabled = false;
      }

      saveContacts() {
        this.childInfo.motherPhone = document.getElementById('motherPhone').value;
        this.childInfo.fatherPhone = document.getElementById('fatherPhone').value;
        this.childInfo.doctorPhone = document.getElementById('doctorPhone').value;
        localStorage.setItem('childInfo', JSON.stringify(this.childInfo));
        alert('–ö–æ–Ω—Ç–∞–∫—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      }

      saveMedicalInfo() {
        this.childInfo.diagnosis = document.getElementById('childDiagnosis').value;
        this.childInfo.allergies = document.getElementById('childAllergies').value;
        localStorage.setItem('childInfo', JSON.stringify(this.childInfo));
        alert('–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      }

      saveSkillsInfo() {
        this.childInfo.interests = document.getElementById('childInterests').value;
        this.childInfo.dislikes = document.getElementById('childDislikes').value;
        localStorage.setItem('childInfo', JSON.stringify(this.childInfo));
        alert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–≤—ã–∫–∞—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      }

      addToHistory(text) {
        const now = new Date();
        const historyItem = {
          text: text,
          timestamp: now.toISOString(),
          timeString: now.toLocaleTimeString('ru-RU', { 
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit' 
          }),
          dateString: now.toLocaleDateString('ru-RU')
        };
        
        history.unshift(historyItem);
        
        if (history.length > 100) {
          history = history.slice(0, 100);
        }
        
        localStorage.setItem('communicator_history', JSON.stringify(history));
        
        if (this.currentTab === 'history') {
          this.renderHistory();
        }
      }

      renderHistory() {
        const container = document.getElementById('historyContainer');
        container.innerHTML = '';
        
        if (history.length === 0) {
          container.innerHTML = '<div class="no-action-message">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
          return;
        }
        
        history.forEach((item, index) => {
          const historyItem = document.createElement('div');
          historyItem.className = 'history-item';
          
          historyItem.innerHTML = `
            <div class="history-text">${item.text}</div>
            <div class="history-time" title="${item.dateString}">
              ${item.timeString}
            </div>
          `;
          
          historyItem.addEventListener('click', () => {
            this.speakText(item.text);
          });
          
          container.appendChild(historyItem);
        });
      }

      clearHistory() {
        if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤?")) {
          history = [];
          localStorage.setItem('communicator_history', JSON.stringify(history));
          this.renderHistory();
          alert('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
        }
      }

      exportHistory() {
        const dataStr = JSON.stringify(history, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = 'communicator_history_' + new Date().toISOString().slice(0,10) + '.json';
        link.click();
      }

      updateSystemInfo() {
        const container = document.getElementById('systemInfo');
        const cardCount = Object.keys(this.cards).length;
        const cardsJson = JSON.stringify({ cards: this.cards });
        const dataSize = (new Blob([cardsJson]).size / 1024).toFixed(2);
        
        const info = {
          '–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è': '4.5.5',
          '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫': cardCount,
          '–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö': `${dataSize} –ö–ë`,
          '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ': new Date().toLocaleString(),
          '–°–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è': speechRate,
          '–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞': `${(fontSizeScale * 100).toFixed(0)}%`,
          'PIN-–∫–æ–¥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω': currentPin !== DEFAULT_PIN ? '–î–∞' : '–ù–µ—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0000)',
          '–í—Å–µ–≥–æ —Ñ—Ä–∞–∑ –≤ –∏—Å—Ç–æ—Ä–∏–∏': history.length
        };
        
        let html = '';
        for (const [key, value] of Object.entries(info)) {
          html += `
            <div class="settings-info-item">
              <span class="settings-info-label">${key}:</span>
              <span class="settings-info-value">${value}</span>
            </div>
          `;
        }
        
        container.innerHTML = html;
      }
    }
	
    function loadVoices() {
      voices = speechSynthesis.getVoices();
      const voiceSelect = document.getElementById('voiceSelect');
      voiceSelect.innerHTML = '<option value="">–°–∏—Å—Ç–µ–º–Ω—ã–π –≥–æ–ª–æ—Å</option>';
      
      voices.forEach(voice => {
        if (voice.lang.includes('ru') || voice.lang.includes('RU')) {
          const option = document.createElement('option');
          option.value = voice.name;
          option.textContent = `${voice.name} (${voice.lang})`;
          voiceSelect.appendChild(option);
        }
      });
      
      const savedVoice = localStorage.getItem('selected_voice');
      if (savedVoice) {
        voiceSelect.value = savedVoice;
        selectedVoice = voices.find(v => v.name === savedVoice);
      }
    }

document.addEventListener('DOMContentLoaded', async () => {
  const communicator = new Communicator();
  window.communicator = communicator;
  
  document.getElementById('speedSlider').value = speechRate;
  document.getElementById('speedValue').textContent = speechRate;
  document.getElementById('fontSizeSlider').value = fontSizeScale * 100;
  document.getElementById('fontSizeValue').textContent = (fontSizeScale * 100).toFixed(0) + '%';
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–æ–ª–æ—Å–∞
  loadVoices();
  
  // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫—É –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞ –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏
});
  </script>
</body>
</html>
