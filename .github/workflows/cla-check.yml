name: CLA Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

jobs:
  cla-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check if CLA is signed
      uses: actions/github-script@v6
      with:
        script: |
          const issue = await github.rest.issues.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });
          
          const prAuthor = issue.data.user.login;
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });
          
          // Check for CLA agreement in comments
          const claPattern = /–Ø, .*, —Å–æ–≥–ª–∞—Å–µ–Ω —Å —É—Å–ª–æ–≤–∏—è–º–∏ CLA|I agree to the CLA terms/i;
          const hasCLA = comments.data.some(comment => 
            claPattern.test(comment.body) && 
            comment.user.login === prAuthor
          );
          
          if (!hasCLA) {
            // Add CLA reminder
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `üëã @${prAuthor}, —Å–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à Pull Request!

–î–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –≤–∞—à–µ–≥–æ –≤–∫–ª–∞–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å CLA (Contributor License Agreement).

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ—á–∏—Ç–∞–π—Ç–µ [INDIVIDUAL-CLA.md](cla/INDIVIDUAL-CLA.md) –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ, –æ—Å—Ç–∞–≤–∏–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:

\`\`\`
–Ø, [–í–∞—à–µ –ø–æ–ª–Ω–æ–µ –∏–º—è], —Å–æ–≥–ª–∞—Å–µ–Ω —Å —É—Å–ª–æ–≤–∏—è–º–∏ CLA
\`\`\`

**–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ CLA –º—ã –Ω–µ —Å–º–æ–∂–µ–º –ø—Ä–∏–Ω—è—Ç—å –≤–∞—à Pull Request.**

–ï—Å–ª–∏ –≤—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –ø–æ email.`
            });
            
            // Add label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['cla-required']
            });
          } else {
            // Remove label if CLA is signed
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'cla-required'
              });
            } catch (e) {
              console.log('Label not found or already removed');
            }
            
            // Add signed label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['cla-signed']
            });
          }
